name: Build Test Version

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'é€‰æ‹©æ„å»ºç±»å‹'
        required: true
        default: 'test'
        type: choice
        options:
        - test
        - debug
      include_debug:
        description: 'åŒ…å«è°ƒè¯•ä¿¡æ¯'
        required: false
        type: boolean
        default: false

jobs:
  build-test:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install Tesseract OCR
      run: |
        choco install tesseract --version=5.3.3
        echo "C:\Program Files\Tesseract-OCR" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      shell: powershell
      
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        
        # æ ¸å¿ƒGUIå’ŒOCRä¾èµ–
        pip install PyQt5==5.15.10
        pip install pytesseract==0.3.10
        pip install Pillow==10.0.1
        
        # å®‰è£…CPUç‰ˆæœ¬çš„PyTorchï¼ˆé¿å…CUDAä¾èµ–ï¼‰
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
        
        # ç¿»è¯‘æ ¸å¿ƒä¾èµ–
        pip install argostranslate==1.9.6
        pip install stanza
        pip install ctranslate2
        pip install sentencepiece
        
        # å›¾åƒå’Œå±å¹•å¤„ç†
        pip install opencv-python-headless
        pip install mss
        pip install pynput
        pip install screeninfo
        
        # ç½‘ç»œå’Œå…¶ä»–å·¥å…·
        pip install requests==2.31.0
        pip install certifi
        pip install ttkthemes
        pip install numpy>=1.21.0
        
        # æ‰“åŒ…å·¥å…·
        pip install pyinstaller==6.2.0
        
        # å¦‚æœå­˜åœ¨requirements.txtï¼Œä¹Ÿå®‰è£…å®ƒ
        if (Test-Path "requirements.txt") {
          pip install -r requirements.txt
        }
      shell: powershell
      
    - name: Download Tesseract language packs
      run: |
        $tessdata = "C:\Program Files\Tesseract-OCR\tessdata"
        
        # æ ¸å¿ƒè¯­è¨€åŒ…
        $essential_langs = @("eng")
        
        foreach ($lang in $essential_langs) {
          $url = "https://github.com/tesseract-ocr/tessdata_fast/raw/main/$lang.traineddata"
          $output = "$tessdata\$lang.traineddata"
          if (!(Test-Path $output)) {
            Write-Host "Downloading $lang language pack..."
            Invoke-WebRequest -Uri $url -OutFile $output -ErrorAction Stop
          }
        }
      shell: powershell
      
    - name: Create Windows launcher and spec file
      shell: powershell  # å°† bash æ”¹ä¸º powershell
      run: |
        # åˆ›å»ºå¯åŠ¨å™¨
        cat > skylark_launcher.py << 'EOF'
#!/usr/bin/env python3
"""
Skylark Screen Translator - Windows å¯åŠ¨å™¨
"""

import os
import sys
import traceback
import logging

def setup_logging():
    log_format = '[%(levelname)s] %(message)s'
    logging.basicConfig(level=logging.INFO, format=log_format)
    return logging.getLogger(__name__)

logger = setup_logging()

def setup_windows_environment():
    """è®¾ç½® Windows ç¯å¢ƒå˜é‡å’Œè·¯å¾„"""
    app_dir = os.path.dirname(os.path.abspath(__file__))
    internal_dir = os.path.join(app_dir, "_internal")
    
    # SSL è¯ä¹¦
    cert_paths = [
        os.path.join(internal_dir, "certifi", "cacert.pem"),
        os.path.join(app_dir, "certifi", "cacert.pem"),
    ]
    for cert_path in cert_paths:
        if os.path.isfile(cert_path):
            os.environ["SSL_CERT_FILE"] = cert_path
            os.environ["REQUESTS_CA_BUNDLE"] = cert_path
            break
    
    # Tesseract è·¯å¾„
    tesseract_paths = [
        os.path.join(internal_dir, "tesseract", "tesseract.exe"),
        os.path.join(app_dir, "tesseract", "tesseract.exe"),
    ]
    for tesseract_path in tesseract_paths:
        if os.path.isfile(tesseract_path):
            os.environ["TESSERACT_CMD"] = tesseract_path
            break
    
    # Tessdata ç›®å½•
    tessdata_paths = [
        os.path.join(internal_dir, "tessdata"),
        os.path.join(app_dir, "tessdata"),
    ]
    for tessdata_path in tessdata_paths:
        if os.path.isdir(tessdata_path):
            os.environ["TESSDATA_PREFIX"] = tessdata_path
            break

def configure_argos_packages():
    """é…ç½® argostranslate è¯­è¨€åŒ…ç›®å½•"""
    user_data_dir = os.path.join(os.path.expanduser("~"), "AppData", "Local", "argos-translate", "packages")
    
    if os.environ.get("ARGOS_PACKAGES_DIR"):
        return
    
    try:
        os.makedirs(user_data_dir, exist_ok=True)
        os.environ["ARGOS_PACKAGES_DIR"] = user_data_dir
    except Exception:
        pass

def main():
    try:
        setup_windows_environment()
        configure_argos_packages()
        
        app_dir = os.path.dirname(os.path.abspath(__file__))
        main_script = os.path.join(app_dir, "skylark_screen_translator.py")
        
        if not os.path.isfile(main_script):
            print(f"æ‰¾ä¸åˆ°ä¸»ç¨‹åº: {main_script}")
            sys.exit(1)
        
        with open(main_script, "rb") as f:
            code = compile(f.read(), main_script, "exec")
            exec(code, {"__file__": main_script, "__name__": "__main__"})
            
    except Exception as e:
        traceback.print_exc()
        input("ç¨‹åºå¼‚å¸¸ï¼ŒæŒ‰å›è½¦é”®é€€å‡º...")
        sys.exit(1)

if __name__ == "__main__":
    main()
EOF
        
        # åˆ›å»ºPyInstaller specæ–‡ä»¶
        cat > skylark_build.spec << 'EOF'
# -*- mode: python ; coding: utf-8 -*-
import os
from pathlib import Path

block_cipher = None

# æ£€æŸ¥å¿…è¦æ–‡ä»¶
required_files = ['skylark_screen_translator.py', 'online_translator.py']
for file in required_files:
    if not os.path.exists(file):
        raise FileNotFoundError(f'æ‰¾ä¸åˆ°å¿…è¦æ–‡ä»¶: {file}')

print('æ‰¾åˆ°æ‰€æœ‰å¿…è¦æ–‡ä»¶ï¼Œå¼€å§‹æ„å»º...')

a = Analysis(
    ['skylark_launcher.py'],
    pathex=[os.path.abspath('.')],
    binaries=[
        ('C:\\Program Files\\Tesseract-OCR\\tesseract.exe', 'tesseract'),
        ('C:\\Program Files\\Tesseract-OCR\\tessdata\\*.traineddata', 'tessdata'),
    ],
    datas=[
        ('skylark_screen_translator.py', '.'),
        ('online_translator.py', '.'),
        ('skylark.png', '.'),
    ],
    hiddenimports=[
        'PyQt5.QtCore',
        'PyQt5.QtGui', 
        'PyQt5.QtWidgets',
        'PyQt5.sip',
        'sip',
        'PIL',
        'PIL.Image',
        'PIL.ImageGrab',
        'PIL.ImageTk',
        'PIL._tkinter_finder',
        'pytesseract',
        'mss',
        'mss.windows',
        'pynput',
        'pynput.keyboard',
        'pynput.mouse',
        'pynput.keyboard._win32',
        'pynput.mouse._win32',
        'screeninfo',
        'requests',
        'requests.packages.urllib3',
        'requests.adapters',
        'urllib3.contrib.pyopenssl',
        'certifi',
        'argostranslate',
        'argostranslate.package',
        'argostranslate.translate',
        'argostranslate.settings',
        'argostranslate.utils',
        'stanza',
        'ctranslate2',
        'sentencepiece',
        'torch',
        'torchvision',
        'torchaudio',
        'numpy',
        'numpy.core._methods',
        'numpy.lib.format',
        'cv2',
        'ttkthemes',
        'online_translator',
        'json',
        'hashlib',
        'uuid',
        'pkg_resources.py2_warn',
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[
        'matplotlib',
        'scipy', 
        'pandas',
        'jupyter',
        'PyQt5.QtWebEngine',
        'PyQt5.QtWebEngineWidgets',
        'tensorflow',
        'keras',
        'tkinter',
    ],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    [],
    exclude_binaries=True,
    name='SkylarkTranslator',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=False,
    console=False,
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
    icon='skylark.png' if os.path.exists('skylark.png') else None,
)

coll = COLLECT(
    exe,
    a.binaries,
    a.zipfiles,
    a.datas,
    strip=False,
    upx=False,
    upx_exclude=[],
    name='SkylarkTranslator',
)
EOF
      shell: bash
      
    - name: Build with PyInstaller
      run: |
        Write-Host "å¼€å§‹æ„å»º Skylark Screen Translator..."
        pyinstaller skylark_build.spec --clean --noconfirm
        
        if (!(Test-Path "dist\SkylarkTranslator\SkylarkTranslator.exe")) {
          throw "æ„å»ºå¤±è´¥ï¼šæ‰¾ä¸åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
        }
        
        Write-Host "æ„å»ºæˆåŠŸï¼"
        Get-ChildItem "dist\SkylarkTranslator" -Recurse | Measure-Object -Property Length -Sum | ForEach-Object { "æ€»å¤§å°: $([math]::Round($_.Sum/1MB, 2)) MB" }
      shell: powershell
      
    - name: Create portable package
      run: |
        $buildType = "${{ inputs.build_type }}"
        $timestamp = Get-Date -Format "yyyyMMdd_HHmm"
        $packageName = "SkylarkTranslator_Windows_${buildType}_${timestamp}"
        
        # åˆ›å»ºæ‰“åŒ…ç›®å½•
        New-Item -Path "package\$packageName" -ItemType Directory -Force | Out-Null
        
        # å¤åˆ¶ç¨‹åºæ–‡ä»¶
        Copy-Item "dist\SkylarkTranslator\*" "package\$packageName\" -Recurse
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        @"
@echo off
echo å¯åŠ¨ Skylark Screen Translator...
cd /d "%~dp0"
SkylarkTranslator.exe
if errorlevel 1 (
    echo ç¨‹åºå¼‚å¸¸é€€å‡ºï¼Œé”™è¯¯ä»£ç : %errorlevel%
    pause
)
"@ | Out-File -FilePath "package\$packageName\å¯åŠ¨ç¨‹åº.bat" -Encoding Default
        
        # åˆ›å»ºè¯´æ˜æ–‡ä»¶
        @"
Skylark Screen Translator - Windows æµ‹è¯•ç‰ˆ
æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
æ„å»ºç±»å‹: $buildType

== å¿«é€Ÿå¼€å§‹ ==
1. åŒå‡» "å¯åŠ¨ç¨‹åº.bat" æˆ–ç›´æ¥è¿è¡Œ SkylarkTranslator.exe
2. é¦–æ¬¡ä½¿ç”¨è¯·å…ˆè¿›å…¥"è¯­è¨€åŒ…ç®¡ç†"å®‰è£…ç¿»è¯‘åŒ…
3. å®‰è£…å®Œæˆåé‡å¯ç¨‹åºï¼Œåœ¨è®¾ç½®ä¸­é€‰æ‹©ç¿»è¯‘è¯­è¨€

== ä½¿ç”¨è¯´æ˜ ==
â€¢ å·¦é”®æ‹–æ‹½ï¼šé€‰æ‹©å±å¹•åŒºåŸŸ
â€¢ å³é”®åŒå‡»ï¼šæ‰§è¡ŒOCRå’Œç¿»è¯‘
â€¢ å·¦é”®å•å‡»ï¼šæ˜¾ç¤º/éšè—ç¿»è¯‘çª—å£
â€¢ é¼ æ ‡æ»šè½®ï¼šæ»šåŠ¨ç¿»è¯‘å†…å®¹

== æ³¨æ„äº‹é¡¹ ==
â€¢ è¿™æ˜¯æœªç­¾åçš„æµ‹è¯•ç‰ˆæœ¬
â€¢ Windows Defenderå¯èƒ½ä¼šæ˜¾ç¤ºå®‰å…¨è­¦å‘Šï¼ˆæ­£å¸¸ç°è±¡ï¼‰
â€¢ éœ€è¦CPUæ”¯æŒSSE4.1æŒ‡ä»¤é›†
â€¢ å»ºè®®è¿è¡Œå†…å­˜2GBä»¥ä¸Š

== é—®é¢˜åé¦ˆ ==
å¦‚é‡åˆ°é—®é¢˜è¯·åˆ°GitHubä»“åº“åé¦ˆï¼š
https://github.com/jtliaw/Skylark-Screen-Translator

"@ | Out-File -FilePath "package\$packageName\ä½¿ç”¨è¯´æ˜.txt" -Encoding UTF8
        
        # åˆ›å»ºZIPåŒ…
        Compress-Archive -Path "package\$packageName" -DestinationPath "$packageName.zip" -Force
        
        Write-Host "æ‰“åŒ…å®Œæˆ: $packageName.zip"
        echo "PACKAGE_NAME=$packageName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: powershell
      
    - name: Upload test build
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.PACKAGE_NAME }}
        path: ${{ env.PACKAGE_NAME }}.zip
        retention-days: 7
        
    - name: Create build summary
      run: |
        $size = (Get-Item "${{ env.PACKAGE_NAME }}.zip").Length
        $sizeMB = [math]::Round($size/1MB, 2)
        
        Write-Host "## æ„å»ºå®Œæˆ âœ…" 
        Write-Host "- æ„å»ºç±»å‹: ${{ inputs.build_type }}"
        Write-Host "- åŒ…å«è°ƒè¯•ä¿¡æ¯: ${{ inputs.include_debug }}"
        Write-Host "- æ–‡ä»¶å¤§å°: ${sizeMB} MB"
        Write-Host "- æ–‡ä»¶å: ${{ env.PACKAGE_NAME }}.zip"
        Write-Host ""
        Write-Host "ğŸ“¥ ä¸‹è½½æ„å»ºçš„æ–‡ä»¶ï¼š"
        Write-Host "1. ç‚¹å‡»ä¸Šæ–¹çš„ Actions æ ‡ç­¾"
        Write-Host "2. é€‰æ‹©è¿™æ¬¡è¿è¡Œ"
        Write-Host "3. åœ¨ Artifacts éƒ¨åˆ†ä¸‹è½½ ZIP æ–‡ä»¶"
        Write-Host ""
        Write-Host "ğŸ§ª æµ‹è¯•è¯´æ˜ï¼š"
        Write-Host "1. è§£å‹ZIPæ–‡ä»¶"
        Write-Host "2. è¿è¡Œ å¯åŠ¨ç¨‹åº.bat æˆ–ç›´æ¥è¿è¡Œ SkylarkTranslator.exe"
        Write-Host "3. é¦–æ¬¡è¿è¡Œéœ€è¦å®‰è£…è¯­è¨€åŒ…"
      shell: powershell
