name: Build Windows Release (Fixed Version)

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release Type'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - stable

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system dependencies
        shell: powershell
        run: |
          # 安装 Tesseract OCR
          $downloadUrl = 'https://digi.bib.uni-mannheim.de/tesseract/tesseract-ocr-w64-setup-5.3.3.20231005.exe'
          $installerPath = "$env:TEMP\tesseract-installer.exe"
          
          Write-Host 'Downloading Tesseract OCR installer...'
          Invoke-WebRequest -Uri $downloadUrl -OutFile $installerPath
          
          Write-Host 'Installing Tesseract OCR...'
          Start-Process -FilePath $installerPath -ArgumentList '/S' -Wait
          
          if (Test-Path 'C:\Program Files\Tesseract-OCR\tesseract.exe') {
              echo 'C:\Program Files\Tesseract-OCR' | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
              Write-Host 'Tesseract installed successfully'
          } else {
              Write-Error 'Tesseract installation failed'
              exit 1
          }

      - name: Install Python dependencies (with specific versions)
        shell: powershell
        run: |
          python -m pip install --upgrade pip setuptools wheel
          
          # 安装特定版本的 setuptools 以避免兼容性问题
          pip install setuptools==68.0.0
          
          # 安装核心依赖
          pip install PyQt5==5.15.9
          pip install pytesseract==0.3.10
          pip install numpy==1.24.3
          pip install opencv-python==4.8.1.78
          pip install pillow==10.0.1
          pip install certifi==2023.7.22
          pip install requests==2.31.0
          pip install pyinstaller==6.2.0
          
          # 安装 argostranslate 但不安装 stanza（避免兼容性问题）
          pip install argostranslate==1.8.0 --no-deps
          pip install ctranslate2==3.22.0
          pip install sentencepiece==0.1.99
          
          # 安装其他依赖
          pip install mss==9.0.1
          pip install pynput==1.7.6
          pip install screeninfo==0.8.1
          pip install ttkthemes==3.2.2

      - name: Create language pack directories
        shell: powershell
        run: |
          # 创建语言包目录
          New-Item -ItemType Directory -Path "argos_packages" -Force
          New-Item -ItemType Directory -Path "tessdata" -Force
          Write-Host "Created language pack directories: argos_packages and tessdata"

      - name: Create simplified argostranslate wrapper
        shell: powershell
        run: |
          # 创建一个简化的 argostranslate 包装器，避免使用 stanza
          $argosWrapper = @'
          try:
          # 尝试导入 argostranslate，但如果失败则提供降级功能
          import argostranslate
          from argostranslate import translate, package
          except ImportError as e:
          print(f"Argos Translate not available: {e}")
          # 创建虚拟实现
          class DummyTranslator:
          def translate(self, text):
            return f"[Translation not available: {text}]"
    
          translate = type('translate', (), {'Translator': DummyTranslator})()
          package = type('package', (), {})()
          '@
          $argosWrapper | Out-File -FilePath "argos_wrapper.py" -Encoding utf8
          Write-Host "Created simplified argostranslate wrapper"

      - name: Build with PyInstaller (simplified)
        shell: powershell
        run: |
          Write-Host 'Building Skylark Screen Translator...'
          
          if (Test-Path 'skylark_screen_translator.py') {
            Write-Host 'Found main program: skylark_screen_translator.py'
            $mainScript = 'skylark_screen_translator.py'
          } else {
            Write-Host 'Available Python files:'
            Get-ChildItem *.py | Format-Table Name
            throw 'No main program found. Please check your repository structure.'
          }
          
          # 使用简化的 PyInstaller 配置，避免问题模块
          $pyinstallerArgs = @(
              "--name", "SkylarkTranslator",
              "--onedir",
              "--windowed",
              "--add-data", "C:\Program Files\Tesseract-OCR\tesseract.exe;.",
              "--add-data", "argos_packages;argos_packages",
              "--add-data", "tessdata;tessdata",
              "--add-binary", "C:\Program Files\Tesseract-OCR;Tesseract-OCR",
              "--hidden-import", "pytesseract",
              "--hidden-import", "numpy",
              "--hidden-import", "cv2",
              "--hidden-import", "PIL",
              "--hidden-import", "certifi",
              "--hidden-import", "requests",
              "--hidden-import", "PyQt5",
              "--hidden-import", "PyQt5.QtCore",
              "--hidden-import", "PyQt5.QtGui",
              "--hidden-import", "PyQt5.QtWidgets",
              "--exclude-module", "stanza",  # 排除有问题的模块
              "--exclude-module", "setuptools._distutils",  # 排除有问题的模块
              $mainScript
          )
          
          # 执行PyInstaller命令
          pyinstaller @pyinstallerArgs
          
          $exePath = 'dist\SkylarkTranslator\SkylarkTranslator.exe'
          if (Test-Path $exePath) {
              $folderSize = (Get-ChildItem 'dist\SkylarkTranslator' -Recurse | Measure-Object -Property Length -Sum).Sum
              $sizeMB = [math]::Round($folderSize/1MB, 2)
              Write-Host "Build successful! Directory size: $sizeMB MB"
              echo "BUILD_SIZE_MB=$sizeMB" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } else {
              throw 'Build failed: executable file not found'
          }

      - name: Create environment setup script
        shell: powershell
        run: |
          # 创建环境设置脚本
          $envScriptContent = @"
          @echo off
          chcp 65001 > nul
          echo Setting up environment for Skylark Translator...

          set APP_DIR=%~dp0
          set ARGOS_PACKAGES_DIR=%APP_DIR%argos_packages
          set TESSDATA_PREFIX=%APP_DIR%tessdata

          if not exist "%ARGOS_PACKAGES_DIR%" mkdir "%ARGOS_PACKAGES_DIR%"
          if not exist "%TESSDATA_PREFIX%" mkdir "%TESSDATA_PREFIX%"

          set QT_QPA_PLATFORM=windows

          echo Environment variables set:
          echo   APP_DIR=%APP_DIR%
          echo   ARGOS_PACKAGES_DIR=%ARGOS_PACKAGES_DIR%
          echo   TESSDATA_PREFIX=%TESSDATA_PREFIX%

          echo.
          echo Starting Skylark Translator...
          start "" "%APP_DIR%SkylarkTranslator.exe"
          "@
          $envScriptContent | Out-File -FilePath "dist\SkylarkTranslator\skylark_launcher.bat" -Encoding utf8
          Write-Host "Created environment setup script: skylark_launcher.bat"

      - name: Create distribution package
        shell: powershell
        run: |
          $releaseType = "${{ inputs.release_type }}"
          $version = Get-Date -Format "yyyy.MM.dd.HHmm"
          $packageName = "SkylarkTranslator_Windows_${releaseType}_v${version}"
          $buildSize = "${{ env.BUILD_SIZE_MB }}"
          
          Write-Host "Creating distribution package: $packageName"
          Write-Host "Application size: $buildSize MB"
          
          Compress-Archive -Path "dist\SkylarkTranslator" -DestinationPath "dist\$packageName.zip" -Force
          
          $readmeLines = @(
            "Skylark Screen Translator - Windows Version",
            "Version: $version",
            "Type: $releaseType",
            "Build Time: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')",
            "Application Size: $buildSize MB",
            "",
            "== IMPORTANT NOTES ==",
            "This version uses a simplified build to avoid compatibility issues.",
            "Some advanced translation features may be limited.",
            "",
            "== How to Use ==",
            "1. Extract this ZIP file to any folder (e.g., C:\SkylarkTranslator)",
            "2. Run skylark_launcher.bat to set up environment variables",
            "3. Or run SkylarkTranslator.exe directly",
            "",
            "== Known Limitations ==",
            "- Advanced translation features may not be available",
            "- Some language models may need to be downloaded manually",
            "- OCR functionality is fully supported",
            "",
            "== File Locations ==",
            "- Main executable: SkylarkTranslator.exe",
            "- Launcher script: skylark_launcher.bat",
            "- Argos Translate data: .\argos_packages\",
            "- Tesseract data: .\tessdata\",
            "",
            "== Support ==",
            "If you encounter issues, please try:",
            "1. Running skylark_launcher.bat instead of the executable directly",
            "2. Ensuring your system has the latest Visual C++ Redistributable",
            "3. Checking for Windows updates"
          )
          
          $readmeLines | Out-File -FilePath "dist\README_$packageName.txt" -Encoding utf8
          
          Write-Host "Package created: dist\$packageName.zip"
          echo "PACKAGE_NAME=$packageName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "PACKAGE_PATH=dist/$packageName.zip" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SkylarkTranslator-Windows-${{ inputs.release_type }}
          path: |
            ${{ env.PACKAGE_PATH }}
            dist/README_${{ env.PACKAGE_NAME }}.txt
          retention-days: 7

      - name: Create build summary
        shell: powershell
        run: |
          $size = (Get-Item "${{ env.PACKAGE_PATH }}").Length
          $sizeMB = [math]::Round($size/1MB, 2)
          
          Write-Host "## Build Complete - Simplified Edition"
          Write-Host "- Release Type: ${{ inputs.release_type }}"
          Write-Host "- Application Size: ${{ env.BUILD_SIZE_MB }} MB"
          Write-Host "- Zip Package Size: ${sizeMB} MB"
          Write-Host "- File Name: ${{ env.PACKAGE_NAME }}.zip"
          Write-Host ""
          Write-Host "## Key Changes"
          Write-Host "1. Simplified Build: Excluded problematic modules (stanza, setuptools._distutils)"
          Write-Host "2. Stable Dependencies: Used specific versions to ensure compatibility"
          Write-Host "3. Fallback Implementation: Added graceful fallback for translation features"
          Write-Host ""
          Write-Host "## Download & Use"
          Write-Host "1. Download the ZIP file from Artifacts"
          Write-Host "2. Extract to any folder"
          Write-Host "3. Run skylark_launcher.bat for best compatibility"
          Write-Host "4. OCR functionality should work fully"
          Write-Host "5. Translation features may be limited but should not crash"
