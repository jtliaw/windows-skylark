# Skylark Screen Translator - Windows å…å®‰è£…ç‰ˆæœ¬æ„å»ºè„šæœ¬
# PowerShellç‰ˆæœ¬ï¼Œå¯åœ¨æœ¬åœ°Windowsç¯å¢ƒè¿è¡Œ

param(
    [switch]$SkipDependencies,
    [switch]$SkipLanguagePacks,
    [string]$OutputDir = "dist",
    [switch]$CreateInstaller
)

# é¢œè‰²è¾“å‡ºå‡½æ•°
function Write-ColorOutput {
    param(
        [string]$Message,
        [string]$ForegroundColor = "White"
    )
    Write-Host $Message -ForegroundColor $ForegroundColor
}

function Write-Success { param([string]$msg) Write-ColorOutput "âœ… $msg" "Green" }
function Write-Info { param([string]$msg) Write-ColorOutput "â„¹ï¸  $msg" "Cyan" }
function Write-Warning { param([string]$msg) Write-ColorOutput "âš ï¸  $msg" "Yellow" }
function Write-Error { param([string]$msg) Write-ColorOutput "âŒ $msg" "Red" }

Write-Info "=== Skylark Screen Translator Windows æ„å»ºå¼€å§‹ ==="

# æ£€æŸ¥ç³»ç»Ÿè¦æ±‚
function Test-SystemRequirements {
    Write-Info "æ£€æŸ¥ç³»ç»Ÿè¦æ±‚..."
    
    # æ£€æŸ¥Python
    try {
        $pythonVersion = python --version 2>&1
        if ($pythonVersion -match "Python (\d+)\.(\d+)") {
            $major = [int]$matches[1]
            $minor = [int]$matches[2]
            if ($major -eq 3 -and $minor -ge 8) {
                Write-Success "Pythonç‰ˆæœ¬: $pythonVersion"
            } else {
                throw "éœ€è¦Python 3.8æˆ–æ›´é«˜ç‰ˆæœ¬"
            }
        }
    } catch {
        Write-Error "Pythonæœªå®‰è£…æˆ–ç‰ˆæœ¬ä¸ç¬¦åˆè¦æ±‚"
        Write-Info "è¯·å®‰è£…Python 3.8+: https://www.python.org/downloads/"
        exit 1
    }
    
    # æ£€æŸ¥pip
    try {
        pip --version | Out-Null
        Write-Success "pipå·²å¯ç”¨"
    } catch {
        Write-Error "pipä¸å¯ç”¨"
        exit 1
    }
    
    # æ£€æŸ¥Gitï¼ˆå¯é€‰ï¼‰
    try {
        git --version | Out-Null
        Write-Success "Gitå·²å¯ç”¨"
    } catch {
        Write-Warning "Gitä¸å¯ç”¨ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½å—é™"
    }
}

# å®‰è£…Tesseract OCR
function Install-TesseractOCR {
    Write-Info "æ£€æŸ¥å¹¶å®‰è£…Tesseract OCR..."
    
    # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
    $tesseractPaths = @(
        "C:\Program Files\Tesseract-OCR\tesseract.exe",
        "C:\Program Files (x86)\Tesseract-OCR\tesseract.exe"
    )
    
    $tesseractFound = $false
    foreach ($path in $tesseractPaths) {
        if (Test-Path $path) {
            Write-Success "Tesseractå·²å®‰è£…: $path"
            $env:PATH = (Split-Path $path) + ";" + $env:PATH
            $tesseractFound = $true
            break
        }
    }
    
    if (-not $tesseractFound) {
        Write-Info "ä¸‹è½½å¹¶å®‰è£…Tesseract OCR..."
        
        $tesseractUrl = "https://github.com/UB-Mannheim/tesseract/releases/download/v5.3.3.20231005/tesseract-ocr-w64-setup-5.3.3.20231005.exe"
        $installerPath = "$env:TEMP\tesseract-installer.exe"
        
        try {
            Write-Info "ä¸‹è½½Tesseractå®‰è£…ç¨‹åº..."
            Invoke-WebRequest -Uri $tesseractUrl -OutFile $installerPath -UseBasicParsing
            
            Write-Info "å®‰è£…Tesseractï¼ˆé™é»˜å®‰è£…ï¼‰..."
            Start-Process -FilePath $installerPath -ArgumentList "/S" -Wait
            
            # éªŒè¯å®‰è£…
            if (Test-Path "C:\Program Files\Tesseract-OCR\tesseract.exe") {
                $env:PATH = "C:\Program Files\Tesseract-OCR;" + $env:PATH
                Write-Success "Tesseractå®‰è£…æˆåŠŸ"
            } else {
                throw "Tesseractå®‰è£…å¤±è´¥"
            }
            
            # æ¸…ç†å®‰è£…æ–‡ä»¶
            Remove-Item $installerPath -ErrorAction SilentlyContinue
            
        } catch {
            Write-Error "Tesseractå®‰è£…å¤±è´¥: $_"
            Write-Info "è¯·æ‰‹åŠ¨å®‰è£…Tesseract: https://github.com/UB-Mannheim/tesseract/releases"
            exit 1
        }
    }
    
    # ä¸‹è½½è¯­è¨€åŒ…
    Write-Info "ä¸‹è½½Tesseractè¯­è¨€åŒ…..."
    $tessdata = "C:\Program Files\Tesseract-OCR\tessdata"
    if (-not (Test-Path $tessdata)) {
        $tessdata = "C:\Program Files (x86)\Tesseract-OCR\tessdata"
    }
    
    if (Test-Path $tessdata) {
        $languages = @('chi_sim', 'chi_tra', 'jpn', 'kor', 'deu', 'fra', 'spa', 'rus', 'ara', 'hin')
        foreach ($lang in $languages) {
            $langFile = "$tessdata\$lang.traineddata"
            if (-not (Test-Path $langFile)) {
                try {
                    $url = "https://github.com/tesseract-ocr/tessdata/raw/main/$lang.traineddata"
                    Write-Info "ä¸‹è½½è¯­è¨€åŒ…: $lang"
                    Invoke-WebRequest -Uri $url -OutFile $langFile -UseBasicParsing
                    Write-Success "è¯­è¨€åŒ… $lang ä¸‹è½½å®Œæˆ"
                } catch {
                    Write-Warning "è¯­è¨€åŒ… $lang ä¸‹è½½å¤±è´¥: $_"
                }
            } else {
                Write-Info "è¯­è¨€åŒ… $lang å·²å­˜åœ¨"
            }
        }
    }
}

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
function New-VirtualEnvironment {
    Write-Info "åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    
    if (Test-Path "venv") {
        Write-Info "åˆ é™¤ç°æœ‰è™šæ‹Ÿç¯å¢ƒ..."
        Remove-Item -Recurse -Force "venv"
    }
    
    python -m venv venv
    if (-not $?) {
        Write-Error "è™šæ‹Ÿç¯å¢ƒåˆ›å»ºå¤±è´¥"
        exit 1
    }
    
    # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
    & "venv\Scripts\Activate.ps1"
    Write-Success "è™šæ‹Ÿç¯å¢ƒåˆ›å»ºå¹¶æ¿€æ´»æˆåŠŸ"
    
    # å‡çº§pip
    Write-Info "å‡çº§pip..."
    python -m pip install --upgrade pip setuptools wheel
}

# å®‰è£…Pythonä¾èµ–
function Install-PythonDependencies {
    Write-Info "å®‰è£…Pythonä¾èµ–..."
    
    # è®¾ç½®pipé•œåƒï¼ˆå¯é€‰ï¼‰
    $pipConfig = @"
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple/
trusted-host = pypi.tuna.tsinghua.edu.cn
timeout = 120
"@
    
    $pipDir = "$env:APPDATA\pip"
    if (-not (Test-Path $pipDir)) {
        New-Item -ItemType Directory -Force -Path $pipDir | Out-Null
    }
    $pipConfig | Out-File -FilePath "$pipDir\pip.ini" -Encoding UTF8
    
    # æ ¸å¿ƒä¾èµ–
    Write-Info "å®‰è£…æ ¸å¿ƒä¾èµ–..."
    $corePackages = @(
        "PyQt5==5.15.10",
        "Pillow>=9.0.0",
        "numpy>=1.21.0",
        "opencv-python-headless",
        "pytesseract",
        "mss",
        "pynput",
        "requests",
        "screeninfo", 
        "ttkthemes",
        "certifi",
        "pyinstaller"
    )
    
    foreach ($package in $corePackages) {
        Write-Info "å®‰è£…: $package"
        pip install $package
        if (-not $?) {
            Write-Warning "åŒ… $package å®‰è£…å¯èƒ½æœ‰é—®é¢˜ï¼Œç»§ç»­..."
        }
    }
    
    Write-Success "æ ¸å¿ƒä¾èµ–å®‰è£…å®Œæˆ"
}

# å®‰è£…ArgosTranslate
function Install-ArgosTranslate {
    if ($SkipLanguagePacks) {
        Write-Warning "è·³è¿‡ArgosTranslateå®‰è£…"
        return
    }
    
    Write-Info "å®‰è£…ArgosTranslateç¦»çº¿ç¿»è¯‘..."
    
    # è®¾ç½®ç¯å¢ƒå˜é‡å¼ºåˆ¶CPUç‰ˆæœ¬
    $env:FORCE_CUDA = "0"
    $env:USE_CUDA = "0"
    
    try {
        # å®‰è£…PyTorch CPUç‰ˆæœ¬
        Write-Info "å®‰è£…PyTorch CPUç‰ˆæœ¬..."
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
        
        # å®‰è£…ç¿»è¯‘ä¾èµ–
        Write-Info "å®‰è£…ç¿»è¯‘ä¾èµ–..."
        $translatePackages = @("PyYAML", "sentencepiece", "stanza", "ctranslate2")
        foreach ($package in $translatePackages) {
            Write-Info "å®‰è£…: $package"
            pip install $package
        }
        
        # å®‰è£…ArgosTranslate
        Write-Info "å®‰è£…ArgosTranslate..."
        pip install argostranslate
        
        Write-Success "ArgosTranslateå®‰è£…å®Œæˆ"
        
    } catch {
        Write-Error "ArgosTranslateå®‰è£…å¤±è´¥: $_"
        Write-Warning "ç»§ç»­æ„å»ºï¼Œä½†ç¦»çº¿ç¿»è¯‘åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨"
    }
}

# ä¸‹è½½è¯­è¨€åŒ…
function Install-LanguagePacks {
    if ($SkipLanguagePacks) {
        Write-Warning "è·³è¿‡è¯­è¨€åŒ…ä¸‹è½½"
        return
    }
    
    Write-Info "ä¸‹è½½ArgosTranslateè¯­è¨€åŒ…..."
    
    $pythonScript = @"
import sys
import argostranslate.package
import argostranslate.translate

try:
    print('æ›´æ–°åŒ…ç´¢å¼•...')
    argostranslate.package.update_package_index()
    
    available_packages = argostranslate.package.get_available_packages()
    print(f'æ‰¾åˆ° {len(available_packages)} ä¸ªå¯ç”¨åŒ…')
    
    # é€‰æ‹©è¦å®‰è£…çš„è¯­è¨€å¯¹
    desired_langs = ['en', 'zh', 'ja', 'ko', 'de', 'fr', 'es']
    target_packages = [
        pkg for pkg in available_packages
        if pkg.from_code in desired_langs and pkg.to_code in desired_langs
    ]
    
    installed_count = 0
    max_packages = 15  # é™åˆ¶æ•°é‡é¿å…æ„å»ºæ—¶é—´è¿‡é•¿
    
    for i, pkg in enumerate(target_packages[:max_packages]):
        try:
            print(f'[{i+1}/{min(len(target_packages), max_packages)}] å®‰è£…: {pkg.from_code} -> {pkg.to_code}')
            download_path = pkg.download()
            argostranslate.package.install_from_path(download_path)
            installed_count += 1
            print('âœ… å®‰è£…æˆåŠŸ')
        except Exception as e:
            print(f'âŒ å®‰è£…å¤±è´¥: {e}')
    
    print(f'\næˆåŠŸå®‰è£… {installed_count} ä¸ªè¯­è¨€åŒ…')
    
    # éªŒè¯å®‰è£…
    installed_packages = argostranslate.package.get_installed_packages()
    print(f'å·²å®‰è£…çš„åŒ…: {len(installed_packages)}')
    for pkg in installed_packages:
        print(f'  - {pkg.from_code} -> {pkg.to_code}')
        
    # æµ‹è¯•ç¿»è¯‘
    if installed_packages:
        test_pkg = None
        for pkg in installed_packages:
            if pkg.from_code == 'en' and pkg.to_code == 'zh':
                test_pkg = pkg
                break
        
        if test_pkg:
            result = argostranslate.translate.translate('Hello world', 'en', 'zh')
            print(f'\næµ‹è¯•ç¿»è¯‘: Hello world -> {result}')
            print('âœ… ç¿»è¯‘åŠŸèƒ½éªŒè¯æˆåŠŸ')
        
except Exception as e:
    print(f'è¯­è¨€åŒ…å®‰è£…è¿‡ç¨‹å‡ºé”™: {e}')
    print('åŸºç¡€æ¡†æ¶ä»ç„¶å¯ç”¨')
    sys.exit(0)  # ä¸è¦å› ä¸ºè¯­è¨€åŒ…å¤±è´¥è€Œä¸­æ–­æ•´ä¸ªæ„å»º
"@

    $pythonScript | python
    Write-Success "è¯­è¨€åŒ…ä¸‹è½½å®Œæˆ"
}

# æ£€æŸ¥å’Œå¢å¼ºæºæ–‡ä»¶
function Test-SourceFiles {
    Write-Info "æ£€æŸ¥æºæ–‡ä»¶..."
    
    $requiredFiles = @("skylark_screen_translator.py")
    $missingFiles = @()
    
    foreach ($file in $requiredFiles) {
        if (-not (Test-Path $file)) {
            $missingFiles += $file
        }
    }
    
    if ($missingFiles.Count -gt 0) {
        Write-Error "ç¼ºå°‘å¿…è¦æ–‡ä»¶:"
        foreach ($file in $missingFiles) {
            Write-Error "  - $file"
        }
        exit 1
    }
    
    # æ£€æŸ¥online_translator.py
    if (-not (Test-Path "online_translator.py")) {
        Write-Info "åˆ›å»ºå¢å¼ºçš„online_translator.py..."
        New-EnhancedOnlineTranslator
    } else {
        Write-Info "online_translator.pyå·²å­˜åœ¨ï¼Œåˆ›å»ºå¢å¼ºç‰ˆæœ¬..."
        Copy-Item "online_translator.py" "online_translator_backup.py"
        New-EnhancedOnlineTranslator
    }
    
    Write-Success "æºæ–‡ä»¶æ£€æŸ¥å®Œæˆ"
}

# åˆ›å»ºå¢å¼ºçš„online_translator.py
function New-EnhancedOnlineTranslator {
    $translatorCode = @'
#!/usr/bin/env python3
"""
Enhanced Online Translator with ArgosTranslate support
Windowsç‰ˆæœ¬ï¼Œå…¼å®¹Skylark Screen Translator
"""

import os
import sys
import logging
from typing import List, Dict, Optional, Any

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

class OnlineTranslator:
    """å¢å¼ºçš„ç¿»è¯‘å™¨ï¼Œæ”¯æŒArgosTranslateç¦»çº¿ç¿»è¯‘"""
    
    def __init__(self):
        self.name = "Enhanced Translator (Windows)"
        self.installed_packages = []
        self.argos_available = False
        self.initialize_argos()
        
    def initialize_argos(self):
        """åˆå§‹åŒ–ArgosTranslate"""
        try:
            import argostranslate.package
            import argostranslate.translate
            
            self.argos_package = argostranslate.package
            self.argos_translate = argostranslate.translate
            self.installed_packages = self.argos_package.get_installed_packages()
            self.argos_available = True
            
            logger.info(f"ArgosTranslateåˆå§‹åŒ–æˆåŠŸï¼Œå·²å®‰è£… {len(self.installed_packages)} ä¸ªè¯­è¨€åŒ…")
            
            # æ‰“å°å·²å®‰è£…çš„åŒ…
            for pkg in self.installed_packages:
                logger.debug(f"å·²å®‰è£…: {pkg.from_code} -> {pkg.to_code}")
                
        except ImportError as e:
            logger.warning(f"ArgosTranslateä¸å¯ç”¨: {e}")
            self.argos_available = False
        except Exception as e:
            logger.error(f"ArgosTranslateåˆå§‹åŒ–å¤±è´¥: {e}")
            self.argos_available = False
            
    def translate(self, text: str, source_lang: str = 'auto', target_lang: str = 'en') -> str:
        """ä¸»è¦ç¿»è¯‘æ–¹æ³•"""
        if not text or not text.strip():
            return text
            
        try:
            # å°è¯•ä½¿ç”¨ArgosTranslateç¦»çº¿ç¿»è¯‘
            if self.argos_available and hasattr(self, 'argos_translate'):
                # è¯­è¨€ä»£ç è½¬æ¢
                source_lang = self._normalize_lang_code(source_lang, text)
                target_lang = self._normalize_lang_code(target_lang)
                
                # æ£€æŸ¥æ˜¯å¦æœ‰mainå‡½æ•°
            if hasattr(skylark_screen_translator, 'main'):
                skylark_screen_translator.main()
            elif hasattr(skylark_screen_translator, 'app'):
                # å¦‚æœæœ‰appå¯¹è±¡ï¼Œç›´æ¥è¿è¡Œ
                app = skylark_screen_translator.app
                sys.exit(app.exec_())
            else:
                # å°è¯•æ‰§è¡Œæ¨¡å—
                logger.info("ä»¥æ¨¡å—æ–¹å¼æ‰§è¡Œä¸»ç¨‹åº")
                exec(open('skylark_screen_translator.py').read())
                
        except ImportError as e:
            logger.error(f"æ— æ³•å¯¼å…¥ä¸»æ¨¡å—: {e}")
            # å°è¯•ç›´æ¥æ‰§è¡Œæ–‡ä»¶
            main_script = os.path.join(os.path.dirname(__file__), 'skylark_screen_translator.py')
            if os.path.exists(main_script):
                logger.info("å°è¯•ç›´æ¥æ‰§è¡Œä¸»è„šæœ¬")
                with open(main_script, 'r', encoding='utf-8') as f:
                    exec(f.read())
            else:
                raise FileNotFoundError("æ‰¾ä¸åˆ°ä¸»ç¨‹åºæ–‡ä»¶")
                
    except Exception as e:
        logger.error(f"åº”ç”¨å¯åŠ¨å¤±è´¥: {e}")
        traceback.print_exc()
        
        # æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        try:
            from PyQt5.QtWidgets import QApplication, QMessageBox
            import sys
            
            app = QApplication(sys.argv)
            msg = QMessageBox()
            msg.setIcon(QMessageBox.Critical)
            msg.setWindowTitle("Skylark Screen Translator - å¯åŠ¨é”™è¯¯")
            msg.setText(f"åº”ç”¨å¯åŠ¨å¤±è´¥:\n\n{str(e)}")
            msg.setDetailedText(traceback.format_exc())
            msg.exec_()
            
        except:
            # å¦‚æœQtä¹Ÿä¸å¯ç”¨ï¼Œä½¿ç”¨æ§åˆ¶å°è¾“å‡º
            print(f"å¯åŠ¨é”™è¯¯: {e}")
            input("æŒ‰Enteré€€å‡º...")
        
        sys.exit(1)

if __name__ == '__main__':
    main()
'@
    
    $launcherCode | Out-File -FilePath "skylark_launcher.py" -Encoding UTF8
    Write-Success "Windowså¯åŠ¨å™¨åˆ›å»ºå®Œæˆ"
}

# åˆ›å»ºPyInstallerè§„èŒƒæ–‡ä»¶
function New-PyInstallerSpec {
    Write-Info "åˆ›å»ºPyInstallerè§„èŒƒæ–‡ä»¶..."
    
    $specCode = @'
# -*- mode: python ; coding: utf-8 -*-

import os
import sys
from PyInstaller.utils.hooks import collect_data_files, collect_submodules

block_cipher = None

# æ”¶é›†éšè—å¯¼å…¥
hiddenimports = [
    # PyQt5æ ¸å¿ƒ
    'PyQt5.QtCore', 'PyQt5.QtGui', 'PyQt5.QtWidgets', 
    'PyQt5.sip', 'sip',
    
    # å›¾åƒå¤„ç†
    'PIL', 'PIL.Image', 'PIL.ImageGrab', 'PIL.ImageTk',
    'cv2', 'numpy', 'numpy.core._methods', 'numpy.lib.format',
    
    # OCRå’Œå±å¹•æ•è·
    'pytesseract', 'mss', 'mss.windows', 
    'pynput', 'pynput.keyboard', 'pynput.mouse',
    'pynput.keyboard._win32', 'pynput.mouse._win32',
    'screeninfo',
    
    # Windowsç‰¹å®š
    'win32gui', 'win32api', 'win32con', 'win32clipboard',
    
    # ç½‘ç»œå’Œå·¥å…·
    'requests', 'requests.packages.urllib3', 'certifi',
    'ttkthemes', 'json', 'hashlib', 'uuid',
    
    # ç¦»çº¿ç¿»è¯‘
    'argostranslate', 'argostranslate.package', 'argostranslate.translate',
    'argostranslate.settings', 'argostranslate.utils',
    'stanza', 'ctranslate2', 'sentencepiece', 
    'torch', 'torch._C', 'torch.nn', 'torch.optim',
    
    # è‡ªå®šä¹‰æ¨¡å—
    'online_translator',
    
    # æ ‡å‡†åº“
    'pkg_resources.py2_warn',
]

# æ”¶é›†æ•°æ®æ–‡ä»¶
datas = []

# ä¸»ç¨‹åºæ–‡ä»¶
main_files = ['skylark_screen_translator.py', 'online_translator.py']
for file in main_files:
    if os.path.exists(file):
        datas.append((file, '.'))

# å›¾æ ‡æ–‡ä»¶
icon_files = ['skylark.png', 'skylark.ico', 'icon.png']
for icon in icon_files:
    if os.path.exists(icon):
        datas.append((icon, '.'))

# SSLè¯ä¹¦
try:
    import certifi
    datas.append((certifi.where(), 'certifi'))
except:
    pass

# ArgosTranslateæ•°æ®
try:
    import argostranslate
    import argostranslate.package
    
    # ArgosTranslateåŒ…ç›®å½•
    argos_path = os.path.dirname(argostranslate.__file__)
    datas.append((argos_path, 'argostranslate'))
    
    # è¯­è¨€åŒ…ç›®å½•
    try:
        packages_path = argostranslate.package.get_package_path()
        if os.path.exists(packages_path) and os.listdir(packages_path):
            datas.append((packages_path, 'argos_packages'))
            print(f"åŒ…å«ArgosTranslateè¯­è¨€åŒ…: {packages_path}")
    except:
        pass
        
    # æ”¶é›†æ‰€æœ‰argostranslateå­æ¨¡å—
    hiddenimports.extend(collect_submodules('argostranslate'))
    
except Exception as e:
    print(f"Warning: ArgosTranslateæ•°æ®æ”¶é›†å¤±è´¥: {e}")

# Tesseractæ•°æ®ï¼ˆå¦‚æœå¯ç”¨ï¼‰
tesseract_paths = [
    r'C:\Program Files\Tesseract-OCR\tessdata',
    r'C:\Program Files (x86)\Tesseract-OCR\tessdata'
]
for tess_path in tesseract_paths:
    if os.path.exists(tess_path):
        # åªåŒ…å«ä¸»è¦è¯­è¨€åŒ…
        important_langs = ['eng.traineddata', 'chi_sim.traineddata', 'chi_tra.traineddata', 
                          'jpn.traineddata', 'kor.traineddata', 'deu.traineddata', 'fra.traineddata']
        for lang_file in important_langs:
            lang_path = os.path.join(tess_path, lang_file)
            if os.path.exists(lang_path):
                datas.append((lang_path, 'tessdata'))
        break

# PyTorchæ•°æ®
try:
    import torch
    torch_data = collect_data_files('torch')
    for item in torch_data:
        if 'lib' in item[0] or '.so' in item[0] or '.dll' in item[0]:
            datas.append(item)
except:
    pass

a = Analysis(
    ['skylark_launcher.py'],
    pathex=[],
    binaries=[],
    datas=datas,
    hiddenimports=hiddenimports,
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[
        # æ’é™¤ä¸éœ€è¦çš„å¤§å‹åº“
        'matplotlib', 'scipy', 'pandas', 'jupyter', 'notebook',
        'PyQt5.QtWebEngine', 'PyQt5.QtWebEngineWidgets',
        'tkinter', 'turtle', 'test', 'unittest',
        # CUDAç›¸å…³ï¼ˆæˆ‘ä»¬ä½¿ç”¨CPUç‰ˆæœ¬ï¼‰
        'torch.backends.cudnn', 'torch.cuda', 'cupy',
    ],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

# è¿‡æ»¤äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç§»é™¤ä¸éœ€è¦çš„DLL
a.binaries = [x for x in a.binaries if not (
    'api-ms-win-' in x[0].lower() or
    'ucrtbase' in x[0].lower() or
    'vcruntime' in x[0].lower()
)]

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    [],
    exclude_binaries=True,
    name='Skylark_Screen_Translator',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,
    console=False,  # Windowsåº”ç”¨ï¼Œä¸æ˜¾ç¤ºæ§åˆ¶å°
    disable_windowed_traceback=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
    icon='skylark.ico' if os.path.exists('skylark.ico') else None,
    version='version_info.txt' if os.path.exists('version_info.txt') else None,
)

coll = COLLECT(
    exe,
    a.binaries,
    a.zipfiles,
    a.datas,
    strip=False,
    upx=True,
    upx_exclude=[],
    name='Skylark_Screen_Translator',
)
'@

    $specCode | Out-File -FilePath "skylark_windows.spec" -Encoding UTF8
    Write-Success "PyInstallerè§„èŒƒæ–‡ä»¶åˆ›å»ºå®Œæˆ"
}

# æ„å»ºåº”ç”¨
function Build-Application {
    Write-Info "æ„å»ºWindowsåº”ç”¨..."
    
    # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
    & "venv\Scripts\Activate.ps1"
    
    # æ¸…ç†ä¹‹å‰çš„æ„å»º
    if (Test-Path "dist") {
        Remove-Item -Recurse -Force "dist"
    }
    if (Test-Path "build") {
        Remove-Item -Recurse -Force "build"
    }
    
    # ä½¿ç”¨PyInstalleræ„å»º
    Write-Info "è¿è¡ŒPyInstaller..."
    python -m PyInstaller skylark_windows.spec --clean --noconfirm --log-level=INFO
    
    if ($LASTEXITCODE -ne 0) {
        Write-Error "PyInstalleræ„å»ºå¤±è´¥"
        return $false
    }
    
    # éªŒè¯æ„å»ºç»“æœ
    $exePath = "dist\Skylark_Screen_Translator\Skylark_Screen_Translator.exe"
    if (-not (Test-Path $exePath)) {
        Write-Error "æ„å»ºçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨"
        return $false
    }
    
    Write-Success "åº”ç”¨æ„å»ºå®Œæˆ: $exePath"
    return $true
}

# åˆ›å»ºä¾¿æºç‰ˆåŒ…
function New-PortablePackage {
    Write-Info "åˆ›å»ºä¾¿æºç‰ˆåŒ…..."
    
    $portableDir = "Skylark_Portable"
    if (Test-Path $portableDir) {
        Remove-Item -Recurse -Force $portableDir
    }
    New-Item -ItemType Directory -Force -Path $portableDir | Out-Null
    
    # å¤åˆ¶åº”ç”¨æ–‡ä»¶
    $distDir = "dist\Skylark_Screen_Translator"
    if (-not (Test-Path $distDir)) {
        Write-Error "æ„å»ºç›®å½•ä¸å­˜åœ¨: $distDir"
        return $false
    }
    
    Write-Info "å¤åˆ¶åº”ç”¨æ–‡ä»¶..."
    Copy-Item -Recurse -Force "$distDir\*" $portableDir
    
    # åˆ›å»ºå¯åŠ¨æ‰¹å¤„ç†æ–‡ä»¶
    Write-Info "åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    $batchContent = @'
@echo off
title Skylark Screen Translator
cd /d "%~dp0"

REM è®¾ç½®ç¯å¢ƒå˜é‡
set PATH=%CD%;%CD%\tessdata;%PATH%
set QT_QPA_PLATFORM=windows
set TESSDATA_PREFIX=%CD%\tessdata

REM æ£€æŸ¥ä¾èµ–
if not exist "Skylark_Screen_Translator.exe" (
    echo é”™è¯¯ï¼šæ‰¾ä¸åˆ°ä¸»ç¨‹åºæ–‡ä»¶
    pause
    exit /b 1
)

REM å¯åŠ¨ç¨‹åºï¼ˆéšè—CMDçª—å£ï¼‰
echo å¯åŠ¨ Skylark Screen Translator...
start "" "Skylark_Screen_Translator.exe"

REM ç­‰å¾…å‡ ç§’é’Ÿç¡®ä¿ç¨‹åºå¯åŠ¨
timeout /t 3 /nobreak >nul

REM å…³é—­æ‰¹å¤„ç†çª—å£
exit /b 0
'@
    $batchContent | Out-File -FilePath "$portableDir\Skylark_Screen_Translator.bat" -Encoding ASCII
    
    # åˆ›å»ºè°ƒè¯•ç‰ˆå¯åŠ¨è„šæœ¬
    $debugBatch = @'
@echo off
title Skylark Screen Translator Debug
cd /d "%~dp0"

echo =================================
echo Skylark Screen Translator Debug
echo =================================
echo.

REM è®¾ç½®ç¯å¢ƒå˜é‡
set PATH=%CD%;%CD%\tessdata;%PATH%
set QT_QPA_PLATFORM=windows
set TESSDATA_PREFIX=%CD%\tessdata

echo ç¯å¢ƒå˜é‡è®¾ç½®å®Œæˆ
echo å½“å‰ç›®å½•: %CD%
echo PATHåŒ…å«: %PATH%
echo.

REM æ£€æŸ¥æ–‡ä»¶
if exist "Skylark_Screen_Translator.exe" (
    echo âœ… æ‰¾åˆ°ä¸»ç¨‹åº
) else (
    echo âŒ æœªæ‰¾åˆ°ä¸»ç¨‹åº
    pause
    exit /b 1
)

if exist "tessdata" (
    echo âœ… æ‰¾åˆ°Tesseractæ•°æ®ç›®å½•
) else (
    echo âš ï¸ æœªæ‰¾åˆ°Tesseractæ•°æ®ç›®å½•
)

echo.
echo å¯åŠ¨ç¨‹åº...
echo å¦‚æœç¨‹åºæ— æ³•å¯åŠ¨ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š
echo 1. Windows Defenderæ˜¯å¦é˜»æ­¢äº†ç¨‹åº
echo 2. æ˜¯å¦æœ‰æ€æ¯’è½¯ä»¶è¯¯æŠ¥
echo 3. æ˜¯å¦ç¼ºå°‘Visual C++ Redistributable
echo.

REM å¯åŠ¨ç¨‹åºï¼ˆä¿æŒCMDçª—å£ï¼‰
"Skylark_Screen_Translator.exe"

echo.
echo ç¨‹åºå·²é€€å‡ºï¼ŒæŒ‰ä»»æ„é”®å…³é—­æ­¤çª—å£...
pause >nul
'@
    $debugBatch | Out-File -FilePath "$portableDir\Debug_Start.bat" -Encoding ASCII
    
    # åˆ›å»ºé…ç½®æ–‡ä»¶
    Write-Info "åˆ›å»ºé…ç½®æ–‡ä»¶..."
    $configContent = @'
# Skylark Screen Translator é…ç½®æ–‡ä»¶
# Windows ä¾¿æºç‰ˆ

[General]
Version=Windows_Portable
Platform=Windows
OCR_Engine=Tesseract
Translation_Engine=ArgosTranslate
Portable_Mode=true
Debug_Mode=false

[OCR]
Tesseract_Data_Path=./tessdata
Default_Language=eng
Auto_Language_Detection=true

[Translation]
Argos_Packages_Path=./argos_packages
Default_Source_Language=auto
Default_Target_Language=zh
Enable_Offline_Translation=true

[UI]
Theme=auto
Language=auto
Window_Always_On_Top=false
Auto_Hide_After_Translation=false

[Advanced]
Log_Level=INFO
Enable_Screenshot_History=true
Max_History_Items=100
Auto_Update_Check=false
'@
    $configContent | Out-File -FilePath "$portableDir\config.ini" -Encoding UTF8
    
    # åˆ›å»ºREADMEæ–‡ä»¶
    Write-Info "åˆ›å»ºè¯´æ˜æ–‡æ¡£..."
    $readmeContent = @"
# Skylark Screen Translator - Windows ä¾¿æºç‰ˆ

## ğŸ¯ è½¯ä»¶ç®€ä»‹
Skylark Screen Translator æ˜¯ä¸€æ¬¾å¼ºå¤§çš„å±å¹•ç¿»è¯‘å·¥å…·ï¼Œæ”¯æŒç¦»çº¿OCRè¯†åˆ«å’Œç¿»è¯‘åŠŸèƒ½ã€‚

## âœ¨ ä¸»è¦ç‰¹æ€§
- ğŸ” ç¦»çº¿OCRæ–‡å­—è¯†åˆ« (Tesseractå¼•æ“)
- ğŸŒ ç¦»çº¿ç¿»è¯‘åŠŸèƒ½ (ArgosTranslateå¼•æ“)  
- ğŸ“¸ å±å¹•æˆªå›¾ç¿»è¯‘
- ğŸ—£ï¸ å¤šè¯­è¨€æ”¯æŒ
- ğŸ“¦ å…å®‰è£…ï¼Œè§£å‹å³ç”¨
- ğŸš€ è½»é‡çº§ï¼Œå¯åŠ¨å¿«é€Ÿ

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿå¯åŠ¨
1. è§£å‹åˆ°ä»»æ„ç›®å½•
2. åŒå‡» `Skylark_Screen_Translator.bat` å¯åŠ¨ç¨‹åº
3. æˆ–ç›´æ¥è¿è¡Œ `Skylark_Screen_Translator.exe`

### è°ƒè¯•æ¨¡å¼
å¦‚æœç¨‹åºæ— æ³•æ­£å¸¸å¯åŠ¨ï¼Œè¯·ä½¿ç”¨ `Debug_Start.bat` æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚

## ğŸŒ æ”¯æŒè¯­è¨€

### OCRè¯†åˆ«
- English (è‹±è¯­)
- ä¸­æ–‡ç®€ä½“ / ç¹ä½“
- æ—¥æœ¬èª (æ—¥è¯­) 
- í•œêµ­ì–´ (éŸ©è¯­)
- Deutsch (å¾·è¯­)
- FranÃ§ais (æ³•è¯­)
- EspaÃ±ol (è¥¿ç­ç‰™è¯­)
- Ğ ÑƒÑÑĞºĞ¸Ğ¹ (ä¿„è¯­)

### ç¿»è¯‘è¯­è¨€
- æ”¯æŒä¸Šè¿°OCRè¯­è¨€ä¹‹é—´çš„äº’è¯‘
- è‡ªåŠ¨è¯­è¨€æ£€æµ‹
- æ™ºèƒ½ç¿»è¯‘ä¼˜åŒ–

## âš™ï¸ ç³»ç»Ÿè¦æ±‚
- Windows 7 SP1 / 8 / 10 / 11
- RAM: æœ€å°‘512MBå¯ç”¨å†…å­˜
- ç£ç›˜: çº¦200MBå¯ç”¨ç©ºé—´
- æ˜¾ç¤ºå™¨: æ”¯æŒ1024x768åˆ†è¾¨ç‡

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜
1. **ç¨‹åºæ— æ³•å¯åŠ¨**
   - æ£€æŸ¥Windows Defenderæ˜¯å¦é˜»æ­¢äº†ç¨‹åº
   - ç¡®è®¤æ€æ¯’è½¯ä»¶æ²¡æœ‰è¯¯æŠ¥
   - å°è¯•ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ

2. **OCRè¯†åˆ«ä¸å‡†ç¡®**
   - ç¡®ä¿æˆªå›¾åŒºåŸŸæ–‡å­—æ¸…æ™°
   - å°è¯•è°ƒæ•´æˆªå›¾åŒºåŸŸå¤§å°
   - æ£€æŸ¥è¯­è¨€è®¾ç½®æ˜¯å¦æ­£ç¡®

3. **ç¿»è¯‘åŠŸèƒ½å¼‚å¸¸**
   - é¦–æ¬¡ä½¿ç”¨å¯èƒ½éœ€è¦ä¸‹è½½è¯­è¨€åŒ…
   - æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼ˆåœ¨çº¿ç¿»è¯‘ï¼‰
   - å°è¯•ä½¿ç”¨ç¦»çº¿ç¿»è¯‘æ¨¡å¼

4. **ç¼ºå°‘Visual C++ Redistributable**
   - ä¸‹è½½å¹¶å®‰è£…æœ€æ–°çš„ Microsoft Visual C++ Redistributable
   - é“¾æ¥: https://aka.ms/vs/17/release/vc_redist.x64.exe

### æ—¥å¿—æ–‡ä»¶
ç¨‹åºè¿è¡Œæ—¥å¿—ä¿å­˜åœ¨åŒç›®å½•ä¸‹çš„ `logs` æ–‡ä»¶å¤¹ä¸­ï¼Œå‡ºç°é—®é¢˜æ—¶å¯æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚

## ğŸ“ æ›´æ–°æ—¥å¿—
- æ”¯æŒå®Œæ•´ç¦»çº¿ç¿»è¯‘
- ä¼˜åŒ–Windowså…¼å®¹æ€§  
- ä¿®å¤PIL.ImageGrabé—®é¢˜
- å¢å¼ºé”™è¯¯å¤„ç†å’Œè°ƒè¯•ä¿¡æ¯
- æ”¹è¿›ä¾¿æºç‰ˆéƒ¨ç½²

## ğŸ”— é¡¹ç›®ä¿¡æ¯
- é¡¹ç›®åœ°å€: https://github.com/jtliaw/Skylark-Screen-Translator
- æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
- æ„å»ºç¯å¢ƒ: PowerShellæ„å»ºè„šæœ¬
- ç‰ˆæœ¬ç±»å‹: Windowsä¾¿æºç‰ˆ

## ğŸ“„ è®¸å¯è¯
è¯·æŸ¥çœ‹é¡¹ç›®ä»“åº“äº†è§£è®¸å¯è¯ä¿¡æ¯ã€‚

## ğŸ†˜ æŠ€æœ¯æ”¯æŒ
å¦‚é‡é—®é¢˜ï¼Œè¯·è®¿é—®é¡¹ç›®GitHubé¡µé¢æäº¤Issueæˆ–æŸ¥çœ‹å·²æœ‰è§£å†³æ–¹æ¡ˆã€‚

---
æ„Ÿè°¢ä½¿ç”¨ Skylark Screen Translatorï¼
"@
    $readmeContent | Out-File -FilePath "$portableDir\README.txt" -Encoding UTF8
    
    Write-Success "ä¾¿æºç‰ˆåŒ…åˆ›å»ºå®Œæˆ: $portableDir"
    return $true
}

# åˆ›å»ºå®‰è£…åŒ…ï¼ˆå¯é€‰ï¼‰
function New-Installer {
    if (-not $CreateInstaller) {
        Write-Info "è·³è¿‡å®‰è£…åŒ…åˆ›å»º"
        return
    }
    
    Write-Info "åˆ›å»ºWindowså®‰è£…åŒ…..."
    
    # æ£€æŸ¥æ˜¯å¦å®‰è£…äº†NSIS
    $nsisPath = Get-Command "makensis.exe" -ErrorAction SilentlyContinue
    if (-not $nsisPath) {
        Write-Warning "æœªæ‰¾åˆ°NSISï¼Œè·³è¿‡å®‰è£…åŒ…åˆ›å»º"
        Write-Info "è¦åˆ›å»ºå®‰è£…åŒ…ï¼Œè¯·å®‰è£…NSIS: https://nsis.sourceforge.io/"
        return
    }
    
    # åˆ›å»ºNSISè„šæœ¬
    $nsisScript = @'
!include "MUI2.nsh"
!include "FileAssociation.nsh"

Name "Skylark Screen Translator"
OutFile "Skylark_Screen_Translator_Setup.exe"
InstallDir "$PROGRAMFILES\Skylark Screen Translator"
RequestExecutionLevel admin

; ç•Œé¢é…ç½®
!define MUI_ABORTWARNING
!define MUI_ICON "${NSISDIR}\Contrib\Graphics\Icons\modern-install.ico"

; å®‰è£…é¡µé¢
!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_LICENSE "LICENSE.txt"
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_INSTFILES
!insertmacro MUI_PAGE_FINISH

; å¸è½½é¡µé¢
!insertmacro MUI_UNPAGE_WELCOME
!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES
!insertmacro MUI_UNPAGE_FINISH

; è¯­è¨€æ–‡ä»¶
!insertmacro MUI_LANGUAGE "English"
!insertmacro MUI_LANGUAGE "SimpChinese"

Section "Main Application" SecMain
    SetOutPath "$INSTDIR"
    File /r "Skylark_Portable\*.*"
    
    ; åˆ›å»ºå¿«æ·æ–¹å¼
    CreateDirectory "$SMPROGRAMS\Skylark Screen Translator"
    CreateShortCut "$SMPROGRAMS\Skylark Screen Translator\Skylark Screen Translator.lnk" "$INSTDIR\Skylark_Screen_Translator.exe"
    CreateShortCut "$DESKTOP\Skylark Screen Translator.lnk" "$INSTDIR\Skylark_Screen_Translator.exe"
    
    ; æ³¨å†Œå¸è½½ç¨‹åº
    WriteUninstaller "$INSTDIR\Uninstall.exe"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\SkylarkTranslator" "DisplayName" "Skylark Screen Translator"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\SkylarkTranslator" "UninstallString" "$INSTDIR\Uninstall.exe"
SectionEnd

Section "Uninstall"
    Delete "$INSTDIR\*.*"
    RMDir /r "$INSTDIR"
    Delete "$SMPROGRAMS\Skylark Screen Translator\*.*"
    RMDir "$SMPROGRAMS\Skylark Screen Translator"
    Delete "$DESKTOP\Skylark Screen Translator.lnk"
    DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\SkylarkTranslator"
SectionEnd
'@
    
    $nsisScript | Out-File -FilePath "installer.nsi" -Encoding ASCII
    
    # è¿è¡ŒNSISç¼–è¯‘
    & "makensis.exe" "installer.nsi"
    
    if ($LASTEXITCODE -eq 0) {
        Write-Success "å®‰è£…åŒ…åˆ›å»ºæˆåŠŸ: Skylark_Screen_Translator_Setup.exe"
    } else {
        Write-Error "å®‰è£…åŒ…åˆ›å»ºå¤±è´¥"
    }
}

# å‹ç¼©ä¾¿æºç‰ˆ
function Compress-PortablePackage {
    Write-Info "å‹ç¼©ä¾¿æºç‰ˆåŒ…..."
    
    $portableDir = "Skylark_Portable"
    if (-not (Test-Path $portableDir)) {
        Write-Error "ä¾¿æºç‰ˆç›®å½•ä¸å­˜åœ¨"
        return
    }
    
    # åˆ›å»ºZIPå‹ç¼©åŒ…
    $zipName = "Skylark_Screen_Translator_Windows_Portable.zip"
    if (Test-Path $zipName) {
        Remove-Item $zipName -Force
    }
    
    Write-Info "åˆ›å»ºZIPå‹ç¼©åŒ…..."
    Compress-Archive -Path "$portableDir\*" -DestinationPath $zipName -CompressionLevel Optimal
    
    if (Test-Path $zipName) {
        $size = [math]::Round((Get-Item $zipName).Length / 1MB, 2)
        Write-Success "ZIPå‹ç¼©åŒ…åˆ›å»ºå®Œæˆ: $zipName (${size}MB)"
    }
    
    # å°è¯•åˆ›å»º7zå‹ç¼©åŒ…ï¼ˆå¦‚æœ7zå¯ç”¨ï¼‰
    $sevenZip = Get-Command "7z.exe" -ErrorAction SilentlyContinue
    if ($sevenZip) {
        $sevenZipName = "Skylark_Screen_Translator_Windows_Portable.7z"
        Write-Info "åˆ›å»º7zå‹ç¼©åŒ…..."
        & "7z.exe" a -t7z -mx=9 $sevenZipName "$portableDir\*"
        
        if ($LASTEXITCODE -eq 0 -and (Test-Path $sevenZipName)) {
            $size7z = [math]::Round((Get-Item $sevenZipName).Length / 1MB, 2)
            Write-Success "7zå‹ç¼©åŒ…åˆ›å»ºå®Œæˆ: $sevenZipName (${size7z}MB)"
        }
    } else {
        Write-Info "7-Zipä¸å¯ç”¨ï¼Œè·³è¿‡7zå‹ç¼©åŒ…åˆ›å»º"
    }
}

# æµ‹è¯•åº”ç”¨
function Test-Application {
    Write-Info "æµ‹è¯•åº”ç”¨..."
    
    $exePath = "Skylark_Portable\Skylark_Screen_Translator.exe"
    if (-not (Test-Path $exePath)) {
        Write-Error "å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: $exePath"
        return $false
    }
    
    Write-Info "éªŒè¯æ–‡ä»¶å®Œæ•´æ€§..."
    $requiredFiles = @(
        "Skylark_Portable\Skylark_Screen_Translator.exe",
        "Skylark_Portable\Skylark_Screen_Translator.bat", 
        "Skylark_Portable\Debug_Start.bat",
        "Skylark_Portable\config.ini",
        "Skylark_Portable\README.txt"
    )
    
    $allFound = $true
    foreach ($file in $requiredFiles) {
        if (Test-Path $file) {
            Write-Success "âœ… $file"
        } else {
            Write-Error "âŒ $file"
            $allFound = $false
        }
    }
    
    if ($allFound) {
        Write-Success "æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡"
        
        # å°è¯•å¿«é€Ÿå¯åŠ¨æµ‹è¯•ï¼ˆä»…å¯åŠ¨å‡ ç§’é’Ÿï¼‰
        try {
            Write-Info "å°è¯•å¯åŠ¨æµ‹è¯•ï¼ˆ5ç§’åè‡ªåŠ¨å…³é—­ï¼‰..."
            $process = Start-Process -FilePath $exePath -PassThru
            Start-Sleep -Seconds 5
            if (-not $process.HasExited) {
                $process.CloseMainWindow()
                Start-Sleep -Seconds 2
                if (-not $process.HasExited) {
                    $process.Kill()
                }
            }
            Write-Success "åº”ç”¨å¯åŠ¨æµ‹è¯•é€šè¿‡"
        } catch {
            Write-Warning "å¯åŠ¨æµ‹è¯•å¤±è´¥ï¼ˆå¯èƒ½éœ€è¦GUIç¯å¢ƒï¼‰: $_"
        }
        
        return $true
    } else {
        return $false
    }
}

# æ˜¾ç¤ºæ„å»ºç»“æœ
function Show-BuildResults {
    Write-Info "=== æ„å»ºç»“æœ ==="
    
    # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶
    $outputFiles = @()
    
    if (Test-Path "Skylark_Portable") {
        $portableSize = (Get-ChildItem "Skylark_Portable" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
        $outputFiles += "ğŸ“ Skylark_Portable/ (${portableSize:F1}MB) - ä¾¿æºç‰ˆæ–‡ä»¶å¤¹"
    }
    
    if (Test-Path "Skylark_Screen_Translator_Windows_Portable.zip") {
        $zipSize = (Get-Item "Skylark_Screen_Translator_Windows_Portable.zip").Length / 1MB
        $outputFiles += "ğŸ“¦ Skylark_Screen_Translator_Windows_Portable.zip (${zipSize:F1}MB)"
    }
    
    if (Test-Path "Skylark_Screen_Translator_Windows_Portable.7z") {
        $sevenZSize = (Get-Item "Skylark_Screen_Translator_Windows_Portable.7z").Length / 1MB
        $outputFiles += "ğŸ“¦ Skylark_Screen_Translator_Windows_Portable.7z (${sevenZSize:F1}MB) - æ›´å°"
    }
    
    if (Test-Path "Skylark_Screen_Translator_Setup.exe") {
        $setupSize = (Get-Item "Skylark_Screen_Translator_Setup.exe").Length / 1MB
        $outputFiles += "ğŸ”§ Skylark_Screen_Translator_Setup.exe (${setupSize:F1}MB) - å®‰è£…ç¨‹åº"
    }
    
    if ($outputFiles.Count -gt 0) {
        Write-Success "ç”Ÿæˆçš„æ–‡ä»¶:"
        foreach ($file in $outputFiles) {
            Write-Info "  $file"
        }
    } else {
        Write-Warning "æœªæ‰¾åˆ°ç”Ÿæˆçš„æ–‡ä»¶"
    }
    
    Write-Info ""
    Write-Info "ğŸ¯ ä½¿ç”¨è¯´æ˜:"
    Write-Info "1. ä¾¿æºç‰ˆ: è§£å‹ååŒå‡» Skylark_Screen_Translator.bat"
    Write-Info "2. å¦‚æœ‰é—®é¢˜: ä½¿ç”¨ Debug_Start.bat æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯"
    Write-Info "3. é…ç½®æ–‡ä»¶: config.ini"
    Write-Info "4. è¯´æ˜æ–‡æ¡£: README.txt"
    
    Write-Info ""
    Write-Info "ğŸ”§ æ•…éšœæ’é™¤:"
    Write-Info "- Windows Defenderè­¦å‘Š: æ·»åŠ åˆ°ä¿¡ä»»åˆ—è¡¨"
    Write-Info "- å¯åŠ¨å¤±è´¥: ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ"
    Write-Info "- ç¼ºå°‘ä¾èµ–: å®‰è£… Visual C++ Redistributable"
    
    Write-Success "=== Windowsæ„å»ºå®Œæˆï¼==="
}

# ä¸»æ‰§è¡Œæµç¨‹
function Main {
    try {
        # æ£€æŸ¥ç³»ç»Ÿè¦æ±‚
        Test-SystemRequirements
        
        # æ£€æŸ¥æºæ–‡ä»¶
        Test-SourceFiles
        
        if (-not $SkipDependencies) {
            # å®‰è£…Tesseract OCR
            Install-TesseractOCR
            
            # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
            New-VirtualEnvironment
            
            # å®‰è£…Pythonä¾èµ–
            Install-PythonDependencies
            
            # å®‰è£…ArgosTranslate
            Install-ArgosTranslate
            
            # ä¸‹è½½è¯­è¨€åŒ…
            Install-LanguagePacks
        }
        
        # åˆ›å»ºWindowså¯åŠ¨å™¨
        New-WindowsLauncher
        
        # åˆ›å»ºPyInstallerè§„èŒƒæ–‡ä»¶
        New-PyInstallerSpec
        
        # æ„å»ºåº”ç”¨
        if (-not (Build-Application)) {
            Write-Error "åº”ç”¨æ„å»ºå¤±è´¥"
            exit 1
        }
        
        # åˆ›å»ºä¾¿æºç‰ˆåŒ…
        if (-not (New-PortablePackage)) {
            Write-Error "ä¾¿æºç‰ˆåŒ…åˆ›å»ºå¤±è´¥"
            exit 1
        }
        
        # åˆ›å»ºå®‰è£…åŒ…ï¼ˆå¯é€‰ï¼‰
        New-Installer
        
        # å‹ç¼©ä¾¿æºç‰ˆ
        Compress-PortablePackage
        
        # æµ‹è¯•åº”ç”¨
        Test-Application
        
        # æ˜¾ç¤ºæ„å»ºç»“æœ
        Show-BuildResults
        
        Write-Success "æ‰€æœ‰æ„å»ºæ­¥éª¤å®Œæˆï¼"
        
    } catch {
        Write-Error "æ„å»ºè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: $_"
        Write-Error "é”™è¯¯è¯¦æƒ…: $($_.Exception.Message)"
        Write-Error "é”™è¯¯ä½ç½®: $($_.ScriptStackTrace)"
        exit 1
    }
}

# æ¸…ç†å‡½æ•°
function Cleanup {
    Write-Info "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
    
    $tempItems = @("build", "*.spec", "__pycache__", "*.pyc")
    foreach ($item in $tempItems) {
        if (Test-Path $item) {
            Remove-Item -Recurse -Force $item -ErrorAction SilentlyContinue
        }
    }
    
    Write-Info "æ¸…ç†å®Œæˆ"
}

# å¸®åŠ©ä¿¡æ¯
function Show-Help {
    Write-Host @"
Skylark Screen Translator - Windows æ„å»ºè„šæœ¬

ç”¨æ³•: .\build_windows.ps1 [å‚æ•°]

å‚æ•°:
  -SkipDependencies     è·³è¿‡ä¾èµ–å®‰è£…ï¼ˆç”¨äºé‡æ–°æ„å»ºï¼‰
  -SkipLanguagePacks    è·³è¿‡ArgosTranslateè¯­è¨€åŒ…ä¸‹è½½
  -OutputDir <path>     æŒ‡å®šè¾“å‡ºç›®å½•ï¼ˆé»˜è®¤: distï¼‰
  -CreateInstaller      åˆ›å»ºNSISå®‰è£…ç¨‹åº
  -Help                 æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

ç¤ºä¾‹:
  .\build_windows.ps1                          # å®Œæ•´æ„å»º
  .\build_windows.ps1 -SkipDependencies        # è·³è¿‡ä¾èµ–å®‰è£…
  .\build_windows.ps1 -CreateInstaller         # åˆ›å»ºå®‰è£…ç¨‹åº
  .\build_windows.ps1 -SkipLanguagePacks       # è·³è¿‡è¯­è¨€åŒ…ä¸‹è½½

è¦æ±‚:
  - Windows 7+ 
  - Python 3.8+
  - ç®¡ç†å‘˜æƒé™ï¼ˆå®‰è£…Tesseractæ—¶éœ€è¦ï¼‰

è¾“å‡º:
  - Skylark_Portable/                          # ä¾¿æºç‰ˆæ–‡ä»¶å¤¹
  - Skylark_Screen_Translator_Windows_Portable.zip  # ZIPå‹ç¼©åŒ…
  - Skylark_Screen_Translator_Windows_Portable.7z   # 7zå‹ç¼©åŒ…ï¼ˆå¦‚æœæœ‰7-Zipï¼‰
  - Skylark_Screen_Translator_Setup.exe        # å®‰è£…ç¨‹åºï¼ˆå¯é€‰ï¼‰

é¡¹ç›®åœ°å€: https://github.com/jtliaw/Skylark-Screen-Translator
"@
}

# å‚æ•°å¤„ç†
if ($args -contains "-Help" -or $args -contains "--help" -or $args -contains "/?" -or $args -contains "-h") {
    Show-Help
    exit 0
}

# è¿è¡Œä¸»å‡½æ•°
try {
    Write-Info "Skylark Screen Translator Windowsæ„å»ºè„šæœ¬å¯åŠ¨"
    Write-Info "æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
    Write-Info "PowerShellç‰ˆæœ¬: $($PSVersionTable.PSVersion)"
    Write-Info "æ“ä½œç³»ç»Ÿ: $([System.Environment]::OSVersion.VersionString)"
    Write-Info ""
    
    # æ£€æŸ¥æ‰§è¡Œç­–ç•¥
    $executionPolicy = Get-ExecutionPolicy
    if ($executionPolicy -eq "Restricted") {
        Write-Warning "PowerShellæ‰§è¡Œç­–ç•¥å—é™ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´"
        Write-Info "è¿è¡Œ: Set-ExecutionPolicy RemoteSigned -Scope CurrentUser"
    }
    
    # è¿è¡Œä¸»é€»è¾‘
    Main
    
} catch {
    Write-Error "è„šæœ¬æ‰§è¡Œå¤±è´¥: $_"
    exit 1
} finally {
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    if (-not $args.Contains("-NoCleanup")) {
        Cleanup
    }
    
    Write-Info ""
    Write-Info "æ„å»ºè„šæœ¬æ‰§è¡Œå®Œæˆ"
    Write-Info "ç»“æŸæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
}æœ‰å¯¹åº”çš„è¯­è¨€åŒ…
                available_pair = self._find_translation_pair(source_lang, target_lang)
                if available_pair:
                    result = self.argos_translate.translate(text, source_lang, target_lang)
                    if result and result != text:
                        logger.info(f"ArgosTranslateç¿»è¯‘æˆåŠŸ: {source_lang}->{target_lang}")
                        return result
                        
                # å¦‚æœæ²¡æœ‰ç›´æ¥çš„è¯­è¨€åŒ…ï¼Œå°è¯•é€šè¿‡è‹±è¯­ä¸­è½¬
                if source_lang != 'en' and target_lang != 'en':
                    en_pair = self._find_translation_pair(source_lang, 'en')
                    target_pair = self._find_translation_pair('en', target_lang)
                    
                    if en_pair and target_pair:
                        logger.info(f"å°è¯•é€šè¿‡è‹±è¯­ä¸­è½¬: {source_lang}->en->{target_lang}")
                        en_result = self.argos_translate.translate(text, source_lang, 'en')
                        if en_result:
                            final_result = self.argos_translate.translate(en_result, 'en', target_lang)
                            if final_result:
                                logger.info("è‹±è¯­ä¸­è½¬ç¿»è¯‘æˆåŠŸ")
                                return final_result
                                
        except Exception as e:
            logger.error(f"ç¿»è¯‘å¤±è´¥: {e}")
            
        # å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œè¿”å›å¸¦æ ‡è®°çš„åŸæ–‡
        logger.warning("æ‰€æœ‰ç¿»è¯‘æ–¹æ³•å¤±è´¥ï¼Œè¿”å›åŸæ–‡")
        return f"[ç¿»è¯‘å¤±è´¥] {text}"
        
    def _normalize_lang_code(self, lang_code: str, text: str = None) -> str:
        """æ ‡å‡†åŒ–è¯­è¨€ä»£ç """
        if lang_code == 'auto' and text:
            return self._detect_language(text)
            
        # è¯­è¨€ä»£ç æ˜ å°„
        lang_mapping = {
            'zh-cn': 'zh', 'zh-tw': 'zh', 'chinese': 'zh',
            'japanese': 'ja', 'korean': 'ko', 'german': 'de',
            'french': 'fr', 'spanish': 'es', 'russian': 'ru',
            'italian': 'it', 'portuguese': 'pt', 'arabic': 'ar',
            'hindi': 'hi', 'english': 'en'
        }
        
        return lang_mapping.get(lang_code.lower(), lang_code.lower())
        
    def _detect_language(self, text: str) -> str:
        """ç®€å•çš„è¯­è¨€æ£€æµ‹"""
        if any('\u4e00' <= char <= '\u9fff' for char in text):
            return 'zh'  # ä¸­æ–‡
        elif any('\u3040' <= char <= '\u309f' or '\u30a0' <= char <= '\u30ff' for char in text):
            return 'ja'  # æ—¥æ–‡  
        elif any('\uac00' <= char <= '\ud7af' for char in text):
            return 'ko'  # éŸ©æ–‡
        elif any('\u0400' <= char <= '\u04ff' for char in text):
            return 'ru'  # ä¿„æ–‡
        else:
            return 'en'  # é»˜è®¤è‹±æ–‡
            
    def _find_translation_pair(self, from_lang: str, to_lang: str) -> bool:
        """æŸ¥æ‰¾æ˜¯å¦æœ‰å¯¹åº”çš„ç¿»è¯‘åŒ…"""
        for pkg in self.installed_packages:
            if pkg.from_code == from_lang and pkg.to_code == to_lang:
                return True
        return False
        
    def get_available_translators(self) -> List[Dict[str, str]]:
        """è·å–å¯ç”¨ç¿»è¯‘å™¨åˆ—è¡¨"""
        translators = []
        
        if self.argos_available and self.installed_packages:
            # åŸºäºå·²å®‰è£…åŒ…åˆ›å»ºç¿»è¯‘å™¨é€‰é¡¹
            added_pairs = set()
            for pkg in self.installed_packages:
                pair_key = f"{pkg.from_code}_{pkg.to_code}"
                if pair_key not in added_pairs:
                    translators.append({
                        'name': f"argos_{pkg.from_code}_to_{pkg.to_code}",
                        'display_name': f"ArgosTranslate: {self._get_language_name(pkg.from_code)} â†’ {self._get_language_name(pkg.to_code)}",
                        'from_lang': pkg.from_code,
                        'to_lang': pkg.to_code,
                        'type': 'offline'
                    })
                    added_pairs.add(pair_key)
        
        # æ·»åŠ é€šç”¨ç¦»çº¿ç¿»è¯‘é€‰é¡¹
        if self.argos_available:
            translators.insert(0, {
                'name': 'argos_auto',
                'display_name': 'ArgosTranslate (æ™ºèƒ½ç¦»çº¿ç¿»è¯‘)',
                'from_lang': 'auto',
                'to_lang': 'auto',
                'type': 'offline'
            })
        
        # å¦‚æœæ²¡æœ‰å¯ç”¨ç¿»è¯‘å™¨ï¼Œæä¾›å¤‡ç”¨é€‰é¡¹
        if not translators:
            translators = [{
                'name': 'fallback',
                'display_name': 'åŸºç¡€ç¿»è¯‘å™¨ (ç¦»çº¿)',
                'from_lang': 'auto',
                'to_lang': 'en',
                'type': 'fallback'
            }]
            
        logger.info(f"è¿”å› {len(translators)} ä¸ªå¯ç”¨ç¿»è¯‘å™¨")
        return translators
        
    def get_supported_languages(self) -> Dict[str, str]:
        """è·å–æ”¯æŒçš„è¯­è¨€åˆ—è¡¨"""
        languages = {
            'auto': 'è‡ªåŠ¨æ£€æµ‹',
            'en': 'English', 'zh': 'ä¸­æ–‡', 'ja': 'æ—¥æœ¬èª', 'ko': 'í•œêµ­ì–´',
            'de': 'Deutsch', 'fr': 'FranÃ§ais', 'es': 'EspaÃ±ol', 'ru': 'Ğ ÑƒÑÑĞºĞ¸Ğ¹',
            'it': 'Italiano', 'pt': 'PortuguÃªs', 'ar': 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', 'hi': 'à¤¹à¤¿à¤¨à¥à¤¦à¥€',
            'th': 'à¹„à¸—à¸¢', 'vi': 'Tiáº¿ng Viá»‡t', 'tr': 'TÃ¼rkÃ§e', 'pl': 'Polski',
            'nl': 'Nederlands', 'sv': 'Svenska', 'da': 'Dansk', 'no': 'Norsk',
            'fi': 'Suomi', 'cs': 'ÄŒeÅ¡tina', 'el': 'Î•Î»Î»Î·Î½Î¹ÎºÎ¬', 'uk': 'Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°'
        }
        
        # æ ¹æ®å·²å®‰è£…åŒ…æ·»åŠ é¢å¤–è¯­è¨€
        if hasattr(self, 'installed_packages'):
            for pkg in self.installed_packages:
                if pkg.from_code not in languages:
                    languages[pkg.from_code] = pkg.from_code.upper()
                if pkg.to_code not in languages:
                    languages[pkg.to_code] = pkg.to_code.upper()
                    
        return languages
        
    def get_translator_languages(self, translator_name: str) -> Dict[str, Dict[str, str]]:
        """è·å–ç‰¹å®šç¿»è¯‘å™¨æ”¯æŒçš„è¯­è¨€"""
        supported = self.get_supported_languages()
        return {
            'source_languages': supported,
            'target_languages': supported
        }
        
    def is_available(self) -> bool:
        """æ£€æŸ¥ç¿»è¯‘å™¨æ˜¯å¦å¯ç”¨"""
        return self.argos_available and len(self.installed_packages) > 0
        
    def _get_language_name(self, lang_code: str) -> str:
        """è·å–è¯­è¨€æ˜¾ç¤ºåç§°"""
        names = {
            'en': 'English', 'zh': 'ä¸­æ–‡', 'ja': 'æ—¥æœ¬èª', 'ko': 'í•œêµ­ì–´',
            'de': 'Deutsch', 'fr': 'FranÃ§ais', 'es': 'EspaÃ±ol', 'ru': 'Ğ ÑƒÑÑĞºĞ¸Ğ¹',
            'it': 'Italiano', 'pt': 'PortuguÃªs', 'ar': 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', 'hi': 'à¤¹à¤¿à¤¨à¥à¤¦à¥€',
            'th': 'à¹„à¸—à¸¢', 'vi': 'Tiáº¿ng Viá»‡t', 'tr': 'TÃ¼rkÃ§e', 'pl': 'Polski'
        }
        return names.get(lang_code, lang_code.upper())

# åˆ›å»ºé»˜è®¤ç¿»è¯‘å™¨å®ä¾‹
default_translator = OnlineTranslator()

# å…¼å®¹æ€§å‡½æ•°ï¼Œç”¨äºä¸ä¸»ç¨‹åºæ¥å£
def get_available_translators() -> List[Dict[str, str]]:
    """è·å–å¯ç”¨ç¿»è¯‘å™¨ï¼ˆå…¨å±€å‡½æ•°ï¼‰"""
    return default_translator.get_available_translators()

def get_translator_languages(translator_name: str) -> Dict[str, Dict[str, str]]:
    """è·å–ç¿»è¯‘å™¨è¯­è¨€ï¼ˆå…¨å±€å‡½æ•°ï¼‰"""
    return default_translator.get_translator_languages(translator_name)

def is_translator_available(translator_name: str = None) -> bool:
    """æ£€æŸ¥ç¿»è¯‘å™¨æ˜¯å¦å¯ç”¨ï¼ˆå…¨å±€å‡½æ•°ï¼‰"""
    return default_translator.is_available()

def translate_text(text: str, source_lang: str = 'auto', target_lang: str = 'en', translator_name: str = None) -> str:
    """ç¿»è¯‘æ–‡æœ¬ï¼ˆå…¨å±€å‡½æ•°ï¼‰"""
    return default_translator.translate(text, source_lang, target_lang)

# å‘åå…¼å®¹çš„ç±»åˆ«å
Translator = OnlineTranslator

if __name__ == '__main__':
    # æµ‹è¯•ä»£ç 
    translator = OnlineTranslator()
    
    print("=== Skylark Online Translator æµ‹è¯• ===")
    print(f"ArgosTranslateå¯ç”¨: {translator.argos_available}")
    print(f"å·²å®‰è£…è¯­è¨€åŒ…: {len(translator.installed_packages)}")
    
    translators = translator.get_available_translators()
    print(f"å¯ç”¨ç¿»è¯‘å™¨: {len(translators)}")
    for t in translators[:5]:  # æ˜¾ç¤ºå‰5ä¸ª
        print(f"  - {t['display_name']}")
    
    languages = translator.get_supported_languages()
    print(f"æ”¯æŒè¯­è¨€: {len(languages)} ç§")
    
    # æµ‹è¯•ç¿»è¯‘
    test_cases = [
        ("Hello world", "en", "zh"),
        ("ä½ å¥½ä¸–ç•Œ", "zh", "en"),
        ("This is a test", "auto", "zh")
    ]
    
    print("\n=== ç¿»è¯‘æµ‹è¯• ===")
    for text, src, tgt in test_cases:
        try:
            result = translator.translate(text, src, tgt)
            print(f"{src}->{tgt}: '{text}' â†’ '{result}'")
        except Exception as e:
            print(f"{src}->{tgt}: '{text}' â†’ é”™è¯¯: {e}")
            
    print("\n=== æµ‹è¯•å®Œæˆ ===")
'@

    $translatorCode | Out-File -FilePath "online_translator.py" -Encoding UTF8
    Write-Success "å¢å¼ºçš„online_translator.pyåˆ›å»ºå®Œæˆ"
}

# åˆ›å»ºWindowså¯åŠ¨å™¨
function New-WindowsLauncher {
    Write-Info "åˆ›å»ºWindowså¯åŠ¨å™¨..."
    
    $launcherCode = @'
#!/usr/bin/env python3
"""
Skylark Screen Translator - Windowså¯åŠ¨å™¨
å¤„ç†Windowsç‰¹æœ‰çš„ç¯å¢ƒé…ç½®å’Œä¾èµ–é—®é¢˜
"""

import os
import sys
import traceback
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

def setup_windows_environment():
    """é…ç½®Windowsè¿è¡Œç¯å¢ƒ"""
    try:
        app_dir = os.path.dirname(os.path.abspath(__file__))
        logger.info(f"åº”ç”¨ç›®å½•: {app_dir}")
        
        # è®¾ç½®Tesseractè·¯å¾„
        tesseract_paths = [
            r'C:\Program Files\Tesseract-OCR',
            r'C:\Program Files (x86)\Tesseract-OCR',
            os.path.join(app_dir, 'tesseract'),
            os.path.join(app_dir, '_internal', 'tesseract')
        ]
        
        tesseract_found = False
        for path in tesseract_paths:
            tesseract_exe = os.path.join(path, 'tesseract.exe')
            if os.path.exists(tesseract_exe):
                if path not in os.environ['PATH']:
                    os.environ['PATH'] = path + os.pathsep + os.environ['PATH']
                os.environ['TESSERACT_CMD'] = tesseract_exe
                logger.info(f"Tesseractæ‰¾åˆ°: {tesseract_exe}")
                tesseract_found = True
                break
        
        if not tesseract_found:
            logger.warning("æœªæ‰¾åˆ°Tesseractï¼ŒOCRåŠŸèƒ½å¯èƒ½ä¸å¯ç”¨")
        
        # è®¾ç½®Qtç¯å¢ƒ
        os.environ['QT_QPA_PLATFORM'] = 'windows'
        os.environ['QT_AUTO_SCREEN_SCALE_FACTOR'] = '0'
        
        # Qtæ’ä»¶è·¯å¾„
        qt_plugin_paths = [
            os.path.join(app_dir, '_internal', 'PyQt5', 'Qt5', 'plugins'),
            os.path.join(app_dir, '_internal', 'PyQt5', 'Qt', 'plugins'),
            os.path.join(app_dir, 'PyQt5', 'Qt5', 'plugins')
        ]
        
        for plugin_path in qt_plugin_paths:
            if os.path.exists(plugin_path):
                os.environ['QT_QPA_PLATFORM_PLUGIN_PATH'] = plugin_path
                os.environ['QT_PLUGIN_PATH'] = plugin_path
                logger.info(f"Qtæ’ä»¶è·¯å¾„: {plugin_path}")
                break
        
        # SSLè¯ä¹¦é…ç½®
        try:
            import certifi
            cert_file = certifi.where()
            os.environ['SSL_CERT_FILE'] = cert_file
            os.environ['REQUESTS_CA_BUNDLE'] = cert_file
            logger.info(f"SSLè¯ä¹¦: {cert_file}")
        except ImportError:
            logger.warning("certifiæ¨¡å—ä¸å¯ç”¨")
        
        # ArgosTranslateåŒ…ç›®å½•
        argos_paths = [
            os.path.join(app_dir, '_internal', 'argos_packages'),
            os.path.join(app_dir, 'argos_packages'),
            os.path.join(os.path.expanduser('~'), '.local', 'share', 'argostranslate', 'packages')
        ]
        
        for argos_path in argos_paths:
            if os.path.exists(argos_path):
                os.environ['ARGOS_PACKAGES_DIR'] = argos_path
                logger.info(f"ArgosTranslateåŒ…ç›®å½•: {argos_path}")
                break
        
        # Pythonè·¯å¾„é…ç½®
        internal_path = os.path.join(app_dir, '_internal')
        if os.path.exists(internal_path):
            sys.path.insert(0, internal_path)
            
        sys.path.insert(0, app_dir)
        
        logger.info("Windowsç¯å¢ƒé…ç½®å®Œæˆ")
        
    except Exception as e:
        logger.error(f"ç¯å¢ƒé…ç½®å¤±è´¥: {e}")
        traceback.print_exc()

def check_dependencies():
    """æ£€æŸ¥å…³é”®ä¾èµ–"""
    missing_deps = []
    
    try:
        import PyQt5
        logger.info("PyQt5: OK")
    except ImportError:
        missing_deps.append("PyQt5")
    
    try:
        import PIL
        logger.info("PIL: OK") 
    except ImportError:
        missing_deps.append("PIL/Pillow")
    
    try:
        import pytesseract
        logger.info("pytesseract: OK")
    except ImportError:
        missing_deps.append("pytesseract")
    
    try:
        import argostranslate
        logger.info("argostranslate: OK")
    except ImportError:
        logger.warning("argostranslate: ä¸å¯ç”¨ï¼ˆç¦»çº¿ç¿»è¯‘åŠŸèƒ½å—é™ï¼‰")
    
    if missing_deps:
        logger.error(f"ç¼ºå°‘ä¾èµ–: {', '.join(missing_deps)}")
        return False
    
    return True

def main():
    """ä¸»å¯åŠ¨å‡½æ•°"""
    try:
        logger.info("=== Skylark Screen Translator å¯åŠ¨ä¸­ ===")
        
        # é…ç½®ç¯å¢ƒ
        setup_windows_environment()
        
        # æ£€æŸ¥ä¾èµ–
        if not check_dependencies():
            input("ä¾èµ–æ£€æŸ¥å¤±è´¥ï¼ŒæŒ‰Enteré€€å‡º...")
            sys.exit(1)
        
        # å¯¼å…¥å¹¶å¯åŠ¨ä¸»åº”ç”¨
        logger.info("å¯åŠ¨ä¸»åº”ç”¨...")
        
        try:
            # å°è¯•å¯¼å…¥ä¸»æ¨¡å—
            import skylark_screen_translator
            
            # æ£€æŸ¥æ˜¯å¦
