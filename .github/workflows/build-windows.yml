name: Build Windows Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'å‘å¸ƒç±»å‹'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - stable
      include_debug:
        description: 'åŒ…å«è°ƒè¯•ä¿¡æ¯'
        required: false
        type: boolean
        default: false

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install system dependencies
      run: |
        # å®‰è£… Tesseract OCR
        choco install tesseract --version=5.3.3 -y
        echo "C:\Program Files\Tesseract-OCR" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      shell: powershell
      
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        
        # å®‰è£…é¡¹ç›®ä¾èµ–
        pip install -r requirements.txt
        
        # ç¡®ä¿å®‰è£…äº†æ‰€æœ‰å¿…è¦çš„åŒ…
        pip install pyinstaller==6.2.0
        pip install pywin32
      shell: powershell
      
    - name: Download Tesseract language data
      run: |
        $tessdata = "C:\Program Files\Tesseract-OCR\tessdata"
        New-Item -Path $tessdata -ItemType Directory -Force | Out-Null
        
        # ä¸‹è½½å¿…è¦çš„è¯­è¨€åŒ…
        $languages = @("eng", "chi_sim", "jpn")
        
        foreach ($lang in $languages) {
          $url = "https://github.com/tesseract-ocr/tessdata_fast/raw/main/$lang.traineddata"
          $output = "$tessdata\$lang.traineddata"
          Write-Host "Downloading $lang language data..."
          try {
            Invoke-WebRequest -Uri $url -OutFile $output -ErrorAction Stop
          } catch {
            Write-Host "Failed to download $lang, trying alternative URL..."
            $url = "https://github.com/tesseract-ocr/tessdata/raw/main/$lang.traineddata"
            Invoke-WebRequest -Uri $url -OutFile $output -ErrorAction SilentlyContinue
          }
        }
      shell: powershell
      
    - name: Create launcher script
      shell: powershell
      run: |
        $launcherContent = @"
import os
import sys
import subprocess

if __name__ == '__main__':
    # è®¾ç½®ç¯å¢ƒå˜é‡
    # æ³¨æ„ï¼šåœ¨ here-string ä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦åƒæ™®é€šå­—ç¬¦ä¸²é‚£æ ·å¯¹åæ–œæ è¿›è¡ŒåŒé‡è½¬ä¹‰
    os.environ['TESSERACT_CMD'] = 'C:\\Program Files\\Tesseract-OCR\\tesseract.exe'
    os.environ['TESSDATA_PREFIX'] = 'C:\\Program Files\\Tesseract-OCR\\tessdata'
    
    # è¿è¡Œä¸»ç¨‹åº
    try:
        # å‡è®¾ä½ çš„ä¸»ç¨‹åºæ˜¯ main.py
        # å¦‚æœæ˜¯å…¶ä»–æ–‡ä»¶åï¼Œè¯·åœ¨è¿™é‡Œä¿®æ”¹
        subprocess.run(['python', 'main.py'], check=True)
    except subprocess.CalledProcessError as e:
        print(f'ç¨‹åºå¼‚å¸¸é€€å‡º: {e}')
        input('æŒ‰å›è½¦é”®é€€å‡º...')
        sys.exit(1)
    except Exception as e:
        print(f'å‘ç”ŸæœªçŸ¥é”™è¯¯: {e}')
        input('æŒ‰å›è½¦é”®é€€å‡º...')
        sys.exit(1)
"@
        Set-Content -Path "launcher.py" -Value $launcherContent -Encoding UTF8
        Write-Host "å·²æˆåŠŸåˆ›å»ºå¯åŠ¨å™¨è„šæœ¬ launcher.py"
      
    - name: Build with PyInstaller
      shell: powershell
      run: |
        Write-Host "å¼€å§‹æ„å»º Skylark Screen Translator..."
        
        # ä½¿ç”¨PyInstalleræ‰“åŒ…å¯åŠ¨å™¨è„šæœ¬
        pyinstaller --name SkylarkTranslator `
          --onefile `
          --windowed `
          --add-data "C:\Program Files\Tesseract-OCR\tessdata;tessdata" `
          --hidden-import PyQt5.QtCore `
          --hidden-import PyQt5.QtGui `
          --hidden-import PyQt5.QtWidgets `
          --hidden-import pytesseract `
          --hidden-import PIL `
          --hidden-import mss `
          --hidden-import pynput `
          --hidden-import screeninfo `
          --hidden-import requests `
          --hidden-import argostranslate `
          --hidden-import stanza `
          --hidden-import ctranslate2 `
          --hidden-import sentencepiece `
          --hidden-import numpy `
          --hidden-import cv2 `
          --hidden-import ttkthemes `
          --hidden-import certifi `
          launcher.py
        
        # æ£€æŸ¥æ„å»ºæ˜¯å¦æˆåŠŸ
        if (!(Test-Path "dist\SkylarkTranslator.exe")) {
          throw "æ„å»ºå¤±è´¥ï¼šæ‰¾ä¸åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
        }
        
        Write-Host "æ„å»ºæˆåŠŸï¼"
      
    - name: Create distribution package
      shell: powershell
      run: |
        $releaseType = "${{ inputs.release_type }}"
        $version = Get-Date -Format "yyyy.MM.dd.HHmm"
        $packageName = "SkylarkTranslator_Windows_${releaseType}_v${version}"
        
        # åˆ›å»ºæ‰“åŒ…ç›®å½•
        New-Item -Path "dist\$packageName" -ItemType Directory -Force | Out-Null
        
        # å¤åˆ¶ç¨‹åºæ–‡ä»¶
        Copy-Item "dist\SkylarkTranslator.exe" "dist\$packageName\" -Force
        
        # å¤åˆ¶ Tesseract å¼•æ“ï¼ˆå¯é€‰ï¼Œå¦‚æœç¨‹åºéœ€è¦ï¼‰
        Copy-Item "C:\Program Files\Tesseract-OCR\tesseract.exe" "dist\$packageName\" -Force
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        $batchContent = "@echo off`r`n"
        $batchContent += "chcp 65001 > nul`r`n"
        $batchContent += "echo å¯åŠ¨ Skylark Screen Translator...`r`n"
        $batchContent += "cd /d %~dp0`r`n"
        $batchContent += "start `"`" SkylarkTranslator.exe`r`n"
        
        Set-Content -Path "dist\$packageName\å¯åŠ¨ç¨‹åº.bat" -Value $batchContent -Encoding Default
        
        # åˆ›å»ºè¯´æ˜æ–‡ä»¶
        $readmeContent = "Skylark Screen Translator - Windows ç‰ˆæœ¬`r`n"
        $readmeContent += "ç‰ˆæœ¬: $version`r`n"
        $readmeContent += "ç±»å‹: $releaseType`r`n"
        $readmeContent += "æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`r`n`r`n"
        $readmeContent += "== å¿«é€Ÿå¼€å§‹ ==`r`n"
        $readmeContent += "1. è§£å‹æ‰€æœ‰æ–‡ä»¶åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­ã€‚`r`n"
        $readmeContent += "2. åŒå‡» 'å¯åŠ¨ç¨‹åº.bat' æˆ–ç›´æ¥è¿è¡Œ SkylarkTranslator.exe`r`n"
        $readmeContent += "3. é¦–æ¬¡ä½¿ç”¨è¯·å…ˆè¿›å…¥'è¯­è¨€åŒ…ç®¡ç†'å®‰è£…ç¿»è¯‘åŒ…`r`n"
        $readmeContent += "4. å®‰è£…å®Œæˆåé‡å¯ç¨‹åºï¼Œåœ¨è®¾ç½®ä¸­é€‰æ‹©ç¿»è¯‘è¯­è¨€`r`n`r`n"
        $readmeContent += "== ä½¿ç”¨è¯´æ˜ ==`r`n"
        $readmeContent += "â€¢ å·¦é”®æ‹–æ‹½: é€‰æ‹©å±å¹•åŒºåŸŸ`r`n"
        $readmeContent += "â€¢ å³é”®åŒå‡»: æ‰§è¡ŒOCRå’Œç¿»è¯‘`r`n"
        $readmeContent += "â€¢ å·¦é”®å•å‡»: æ˜¾ç¤º/éšè—ç¿»è¯‘çª—å£`r`n"
        $readmeContent += "â€¢ é¼ æ ‡æ»šè½®: æ»šåŠ¨ç¿»è¯‘å†…å®¹`r`n`r`n"
        $readmeContent += "== æ³¨æ„äº‹é¡¹ ==`r`n"
        $readmeContent += "â€¢ è¿™æ˜¯ä¸€ä¸ªæœªç­¾åçš„æµ‹è¯•ç‰ˆæœ¬ï¼ŒWindows Defenderå¯èƒ½ä¼šæ˜¾ç¤ºå®‰å…¨è­¦å‘Šã€‚`r`n"
        $readmeContent += "â€¢ è¯·ç¡®ä¿tesseract.exeå’Œtessdataæ–‡ä»¶å¤¹ä¸ä¸»ç¨‹åºåœ¨åŒä¸€ç›®å½•ä¸‹ã€‚`r`n"
        
        Set-Content -Path "dist\$packageName\ä½¿ç”¨è¯´æ˜.txt" -Value $readmeContent -Encoding UTF8
        
        # åˆ›å»ºZIPåŒ…
        Compress-Archive -Path "dist\$packageName\*" -DestinationPath "dist\$packageName.zip" -Force
        
        Write-Host "æ‰“åŒ…å®Œæˆ: $packageName.zip"
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "PACKAGE_NAME=$packageName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "PACKAGE_PATH=dist/$packageName.zip" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: SkylarkTranslator-Windows-${{ inputs.release_type }}
        path: ${{ env.PACKAGE_PATH }}
        retention-days: 7
        
    - name: Create release summary
      id: release_summary
      shell: powershell
      run: |
        $size = (Get-Item "${{ env.PACKAGE_PATH }}").Length
        $sizeMB = [math]::Round($size/1MB, 2)
        $summary = @"
        ## Build completed successfully âœ…

        * **Release Type**: `${{ inputs.release_type }}`
        * **Include Debug Info**: `${{ inputs.include_debug }}`
        * **File Name**: `${{ env.PACKAGE_NAME }}.zip`
        * **File Size**: `${sizeMB} MB`

        ### ğŸ“¥ How to Download
        You can download the build artifact directly from the top of this workflow run summary page, under the "Artifacts" section.
        
        ### ğŸ§ª Testing Instructions
        1.  Download and unzip the file.
        2.  Run `å¯åŠ¨ç¨‹åº.bat` or directly execute `SkylarkTranslator.exe`.
        3.  On first launch, you may need to install language packs via the in-app manager.
        ---
        "@
        echo "summary=$summary" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        
    - name: Add summary to workflow
      uses: actions/github-script@v7
      with:
        script: |
          await core.summary
            .addRaw('${{ steps.release_summary.outputs.summary }}')
            .write()
