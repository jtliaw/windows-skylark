name: Build Windows Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: '发布类型'
        required: true
        default: 'test'
        type: choice
        options:
        - test
        - stable
      include_debug:
        description: '包含调试信息'
        required: false
        type: boolean
        default: false

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install system dependencies
      run: |
        # 安装 Tesseract OCR
        choco install tesseract --version=5.3.3 -y
        echo "C:\Program Files\Tesseract-OCR" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        
        # 安装其他系统依赖（如果有）
        # choco install package-name -y
      shell: powershell
      
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        
        # 安装项目依赖
        pip install -r requirements.txt
        
        # 确保安装了所有必要的包
        pip install pyinstaller==6.2.0
        pip install pywin32
      shell: powershell
      
    - name: Download Tesseract language data
      run: |
        $tessdata = "C:\Program Files\Tesseract-OCR\tessdata"
        New-Item -Path $tessdata -ItemType Directory -Force | Out-Null
        
        # 下载必要的语言包
        $languages = @("eng", "chi_sim", "jpn")
        
        foreach ($lang in $languages) {
          $url = "https://github.com/tesseract-ocr/tessdata_fast/raw/main/$lang.traineddata"
          $output = "$tessdata\$lang.traineddata"
          Write-Host "Downloading $lang language data..."
          try {
            Invoke-WebRequest -Uri $url -OutFile $output -ErrorAction Stop
          } catch {
            Write-Host "Failed to download $lang, trying alternative URL..."
            $url = "https://github.com/tesseract-ocr/tessdata/raw/main/$lang.traineddata"
            Invoke-WebRequest -Uri $url -OutFile $output -ErrorAction SilentlyContinue
          }
        }
      shell: powershell
      
    - name: Create launcher script
      run: |
        # 创建Windows启动器
        $launcherContent = @'
#!/usr/bin/env python3
"""
Skylark Screen Translator - Windows 启动器
"""

import os
import sys
import traceback
import logging

def setup_logging():
    log_format = '[%(levelname)s] %(message)s'
    logging.basicConfig(level=logging.INFO, format=log_format)
    return logging.getLogger(__name__)

logger = setup_logging()

def setup_windows_environment():
    """设置 Windows 环境变量和路径"""
    app_dir = os.path.dirname(os.path.abspath(__file__))
    internal_dir = os.path.join(app_dir, "_internal")
    
    # SSL 证书
    cert_paths = [
        os.path.join(internal_dir, "certifi", "cacert.pem"),
        os.path.join(app_dir, "certifi", "cacert.pem"),
    ]
    for cert_path in cert_paths:
        if os.path.isfile(cert_path):
            os.environ["SSL_CERT_FILE"] = cert_path
            os.environ["REQUESTS_CA_BUNDLE"] = cert_path
            break
    
    # Tesseract 路径
    tesseract_paths = [
        os.path.join(internal_dir, "tesseract", "tesseract.exe"),
        os.path.join(app_dir, "tesseract", "tesseract.exe"),
        "C:\\Program Files\\Tesseract-OCR\\tesseract.exe",
    ]
    for tesseract_path in tesseract_paths:
        if os.path.isfile(tesseract_path):
            os.environ["TESSERACT_CMD"] = tesseract_path
            break
    
    # Tessdata 目录
    tessdata_paths = [
        os.path.join(internal_dir, "tessdata"),
        os.path.join(app_dir, "tessdata"),
        "C:\\Program Files\\Tesseract-OCR\\tessdata",
    ]
    for tessdata_path in tessdata_paths:
        if os.path.isdir(tessdata_path):
            os.environ["TESSDATA_PREFIX"] = tessdata_path
            break

def configure_argos_packages():
    """配置 argostranslate 语言包目录"""
    user_data_dir = os.path.join(os.path.expanduser("~"), "AppData", "Local", "argos-translate", "packages")
    
    if os.environ.get("ARGOS_PACKAGES_DIR"):
        return
    
    try:
        os.makedirs(user_data_dir, exist_ok=True)
        os.environ["ARGOS_PACKAGES_DIR"] = user_data_dir
    except Exception:
        pass

def main():
    try:
        setup_windows_environment()
        configure_argos_packages()
        
        app_dir = os.path.dirname(os.path.abspath(__file__))
        main_script = os.path.join(app_dir, "main.py")
        
        if not os.path.isfile(main_script):
            print(f"找不到主程序: {main_script}")
            sys.exit(1)
        
        # 添加当前目录到Python路径
        sys.path.insert(0, app_dir)
        
        # 导入并运行主程序
        from main import main as app_main
        app_main()
            
    except Exception as e:
        traceback.print_exc()
        input("程序异常，按回车键退出...")
        sys.exit(1)

if __name__ == "__main__":
    main()
'@
        $launcherContent | Out-File -FilePath "launcher.py" -Encoding UTF8
      shell: powershell
      
    - name: Prepare PyInstaller spec
      run: |
        # 创建PyInstaller spec文件
        $specContent = @'
# -*- mode: python ; coding: utf-8 -*-
import os
import sys
from PyInstaller.building.build_main import Analysis, EXE, COLLECT
from PyInstaller.building.datastruct import TOC, Tree
from PyInstaller.building.utils import _check_guts_eq

block_cipher = None

# 添加当前目录到路径
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

a = Analysis(
    ['launcher.py'],
    pathex=[os.path.dirname(os.path.abspath(__file__))],
    binaries=[],
    datas=[
        # 包含Python文件
        ('*.py', '.'),
        # 包含图标
        ('*.png', '.'),
        ('*.ico', '.'),
        # 包含数据文件
        ('*.json', '.'),
    ],
    hiddenimports=[
        'PyQt5.QtCore',
        'PyQt5.QtGui',
        'PyQt5.QtWidgets',
        'pytesseract',
        'PIL',
        'PIL.Image',
        'PIL.ImageGrab',
        'mss',
        'pynput',
        'pynput.keyboard',
        'pynput.mouse',
        'screeninfo',
        'requests',
        'argostranslate',
        'argostranslate.package',
        'argostranslate.translate',
        'stanza',
        'ctranslate2',
        'sentencepiece',
        'numpy',
        'cv2',
        'ttkthemes',
        'certifi',
        # 添加其他可能的隐藏导入
        'packaging',
        'packaging.version',
        'packaging.specifiers',
        'packaging.requirements',
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[
        'matplotlib',
        'scipy',
        'pandas',
        'tkinter',
        'test',
        'unittest',
    ],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

# 添加Tesseract二进制文件和数据
tesseract_bin = 'C:\\Program Files\\Tesseract-OCR\\tesseract.exe'
tessdata_dir = 'C:\\Program Files\\Tesseract-OCR\\tessdata'

if os.path.exists(tesseract_bin):
    a.binaries.append((tesseract_bin, 'tesseract'))
    
if os.path.exists(tessdata_dir):
    a.datas.append((tessdata_dir, 'tessdata'))

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    a.binaries,
    a.zipfiles,
    a.datas,
    name='SkylarkTranslator',
    debug=False,
    strip=False,
    upx=True,
    upx_exclude=[],
    runtime_tmpdir=None,
    console=False,
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
    icon='icon.ico' if os.path.exists('icon.ico') else None,
)

coll = COLLECT(
    exe,
    a.binaries,
    a.zipfiles,
    a.datas,
    strip=False,
    upx=True,
    upx_exclude=[],
    name='SkylarkTranslator',
)
'@
        $specContent | Out-File -FilePath "skylark.spec" -Encoding UTF8
      shell: powershell
      
    - name: Build with PyInstaller
      run: |
        Write-Host "开始构建 Skylark Screen Translator..."
        
        # 构建应用
        pyinstaller skylark.spec --clean --noconfirm
        
        # 检查构建是否成功
        if (!(Test-Path "dist\SkylarkTranslator\SkylarkTranslator.exe")) {
          throw "构建失败：找不到可执行文件"
        }
        
        Write-Host "构建成功！"
        
        # 显示构建大小
        Get-ChildItem "dist\SkylarkTranslator" -Recurse | Measure-Object -Property Length -Sum | ForEach-Object { 
          Write-Host "总大小: $([math]::Round($_.Sum/1MB, 2)) MB" 
        }
      shell: powershell
      
    - name: Create distribution package
      run: |
        $releaseType = "${{ inputs.release_type }}"
        $version = Get-Date -Format "yyyy.MM.dd.HHmm"
        $packageName = "SkylarkTranslator_Windows_${releaseType}_v${version}"
        
        # 创建打包目录
        New-Item -Path "dist\$packageName" -ItemType Directory -Force | Out-Null
        
        # 复制程序文件
        Copy-Item "dist\SkylarkTranslator\*" "dist\$packageName\" -Recurse -Force
        
        # 复制语言包
        $tessdataSrc = "C:\Program Files\Tesseract-OCR\tessdata"
        $tessdataDst = "dist\$packageName\tessdata"
        if (Test-Path $tessdataSrc) {
          New-Item -Path $tessdataDst -ItemType Directory -Force | Out-Null
          Copy-Item "$tessdataSrc\*.traineddata" $tessdataDst -Force
        }
        
        # 创建启动脚本
        @"
@echo off
chcp 65001 > nul
echo 启动 Skylark Screen Translator...
cd /d "%~dp0"
start "" SkylarkTranslator.exe
"@ | Out-File -FilePath "dist\$packageName\启动程序.bat" -Encoding Default
        
        # 创建说明文件
        @"
Skylark Screen Translator - Windows 版本
版本: $version
类型: $releaseType
构建时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

== 快速开始 ==
1. 双击 "启动程序.bat" 或直接运行 SkylarkTranslator.exe
2. 首次使用请先进入"语言包管理"安装翻译包
3. 安装完成后重启程序，在设置中选择翻译语言

== 使用说明 ==
• 左键拖拽: 选择屏幕区域
• 右键双击: 执行OCR和翻译
• 左键单击: 显示/隐藏翻译窗口
• 鼠标滚轮: 滚动翻译内容

== 注意事项 ==
• 这是未签名的测试版本
• Windows Defender可能会显示安全警告（正常现象）
• 需要CPU支持SSE4.1指令集
• 建议运行内存2GB以上

== 问题反馈 ==
如遇到问题请到GitHub仓库反馈:
https://github.com/jtliaw/Skylark-Screen-Translator

"@ | Out-File -FilePath "dist\$packageName\使用说明.txt" -Encoding UTF8
        
        # 创建ZIP包
        Compress-Archive -Path "dist\$packageName" -DestinationPath "dist\$packageName.zip" -Force
        
        Write-Host "打包完成: $packageName.zip"
        
        # 设置输出变量
        echo "PACKAGE_NAME=$packageName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "PACKAGE_PATH=dist/$packageName.zip" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: powershell
      
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: SkylarkTranslator-Windows-${{ inputs.release_type }}
        path: ${{ env.PACKAGE_PATH }}
        retention-days: 7
        
    - name: Create release summary
      run: |
        $size = (Get-Item "${{ env.PACKAGE_PATH }}").Length
        $sizeMB = [math]::Round($size/1MB, 2)
        
        Write-Host "## 构建完成 ✅" 
        Write-Host "- 发布类型: ${{ inputs.release_type }}"
        Write-Host "- 包含调试信息: ${{ inputs.include_debug }}"
        Write-Host "- 文件大小: ${sizeMB} MB"
        Write-Host "- 文件名: ${{ env.PACKAGE_NAME }}.zip"
        Write-Host ""
        Write-Host "📥 下载构建的文件:"
        Write-Host "1. 点击上方的 Actions 标签"
        Write-Host "2. 选择这次运行"
        Write-Host "3. 在 Artifacts 部分下载 ZIP 文件"
        Write-Host ""
        Write-Host "🧪 测试说明:"
        Write-Host "1. 解压ZIP文件"
        Write-Host "2. 运行 启动程序.bat 或直接运行 SkylarkTranslator.exe"
        Write-Host "3. 首次运行需要安装语言包"
      shell: powershell
