name: Build Windows Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'å‘å¸ƒç±»å‹'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - stable
      include_debug:
        description: 'åŒ…å«è°ƒè¯•ä¿¡æ¯'
        required: false
        type: boolean
        default: false

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install system dependencies
      run: |
        # å®‰è£… Tesseract OCR
        choco install tesseract --version=5.3.3 -y
        echo "C:\Program Files\Tesseract-OCR" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      shell: powershell
      
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        
        # å®‰è£…é¡¹ç›®ä¾èµ–
        pip install -r requirements.txt
        
        # ç¡®ä¿å®‰è£…äº†æ‰€æœ‰å¿…è¦çš„åŒ…
        pip install pyinstaller==6.2.0
        pip install pywin32
      shell: powershell
      
    - name: Download Tesseract language data
      run: |
        $tessdata = "C:\Program Files\Tesseract-OCR\tessdata"
        New-Item -Path $tessdata -ItemType Directory -Force | Out-Null
        
        # ä¸‹è½½å¿…è¦çš„è¯­è¨€åŒ…
        $languages = @("eng", "chi_sim", "jpn")
        
        foreach ($lang in $languages) {
          $url = "https://github.com/tesseract-ocr/tessdata_fast/raw/main/$lang.traineddata"
          $output = "$tessdata\$lang.traineddata"
          Write-Host "Downloading $lang language data..."
          try {
            Invoke-WebRequest -Uri $url -OutFile $output -ErrorAction Stop
          } catch {
            Write-Host "Failed to download $lang, trying alternative URL..."
            $url = "https://github.com/tesseract-ocr/tessdata/raw/main/$lang.traineddata"
            Invoke-WebRequest -Uri $url -OutFile $output -ErrorAction SilentlyContinue
          }
        }
      shell: powershell
      
    - name: Create launcher script
      run: |
        # åˆ›å»ºå¯åŠ¨å™¨æ–‡ä»¶
        Write-Output "#!/usr/bin/env python3" > launcher.py
        Write-Output '"""' >> launcher.py
        Write-Output "Skylark Screen Translator - Windows å¯åŠ¨å™¨" >> launcher.py
        Write-Output '"""' >> launcher.py
        Write-Output "" >> launcher.py
        Write-Output "import os" >> launcher.py
        Write-Output "import sys" >> launcher.py
        Write-Output "import traceback" >> launcher.py
        Write-Output "import logging" >> launcher.py
        Write-Output "" >> launcher.py
        Write-Output "def setup_logging():" >> launcher.py
        Write-Output "    log_format = '[%(levelname)s] %(message)s'" >> launcher.py
        Write-Output "    logging.basicConfig(level=logging.INFO, format=log_format)" >> launcher.py
        Write-Output "    return logging.getLogger(__name__)" >> launcher.py
        Write-Output "" >> launcher.py
        Write-Output "logger = setup_logging()" >> launcher.py
        Write-Output "" >> launcher.py
        Write-Output "def setup_windows_environment():" >> launcher.py
        Write-Output '    """è®¾ç½® Windows ç¯å¢ƒå˜é‡å’Œè·¯å¾„"""' >> launcher.py
        Write-Output "    app_dir = os.path.dirname(os.path.abspath(__file__))" >> launcher.py
        Write-Output "    internal_dir = os.path.join(app_dir, \"_internal\")" >> launcher.py
        Write-Output "    " >> launcher.py
        Write-Output "    # SSL è¯ä¹¦" >> launcher.py
        Write-Output "    cert_paths = [" >> launcher.py
        Write-Output "        os.path.join(internal_dir, \"certifi\", \"cacert.pem\")," >> launcher.py
        Write-Output "        os.path.join(app_dir, \"certifi\", \"cacert.pem\")," >> launcher.py
        Write-Output "    ]" >> launcher.py
        Write-Output "    for cert_path in cert_paths:" >> launcher.py
        Write-Output "        if os.path.isfile(cert_path):" >> launcher.py
        Write-Output "            os.environ[\"SSL_CERT_FILE\"] = cert_path" >> launcher.py
        Write-Output "            os.environ[\"REQUESTS_CA_BUNDLE\"] = cert_path" >> launcher.py
        Write-Output "            break" >> launcher.py
        Write-Output "    " >> launcher.py
        Write-Output "    # Tesseract è·¯å¾„" >> launcher.py
        Write-Output "    tesseract_paths = [" >> launcher.py
        Write-Output "        os.path.join(internal_dir, \"tesseract\", \"tesseract.exe\")," >> launcher.py
        Write-Output "        os.path.join(app_dir, \"tesseract\", \"tesseract.exe\")," >> launcher.py
        Write-Output "        \"C:\\\\Program Files\\\\Tesseract-OCR\\\\tesseract.exe\"," >> launcher.py
        Write-Output "    ]" >> launcher.py
        Write-Output "    for tesseract_path in tesseract_paths:" >> launcher.py
        Write-Output "        if os.path.isfile(tesseract_path):" >> launcher.py
        Write-Output "            os.environ[\"TESSERACT_CMD\"] = tesseract_path" >> launcher.py
        Write-Output "            break" >> launcher.py
        Write-Output "    " >> launcher.py
        Write-Output "    # Tessdata ç›®å½•" >> launcher.py
        Write-Output "    tessdata_paths = [" >> launcher.py
        Write-Output "        os.path.join(internal_dir, \"tessdata\")," >> launcher.py
        Write-Output "        os.path.join(app_dir, \"tessdata\")," >> launcher.py
        Write-Output "        \"C:\\\\Program Files\\\\Tesseract-OCR\\\\tessdata\"," >> launcher.py
        Write-Output "    ]" >> launcher.py
        Write-Output "    for tessdata_path in tessdata_paths:" >> launcher.py
        Write-Output "        if os.path.isdir(tessdata_path):" >> launcher.py
        Write-Output "            os.environ[\"TESSDATA_PREFIX\"] = tessdata_path" >> launcher.py
        Write-Output "            break" >> launcher.py
        Write-Output "" >> launcher.py
        Write-Output "def configure_argos_packages():" >> launcher.py
        Write-Output '    """é…ç½® argostranslate è¯­è¨€åŒ…ç›®å½•"""' >> launcher.py
        Write-Output "    user_data_dir = os.path.join(os.path.expanduser(\"~\"), \"AppData\", \"Local\", \"argos-translate\", \"packages\")" >> launcher.py
        Write-Output "    " >> launcher.py
        Write-Output "    if os.environ.get(\"ARGOS_PACKAGES_DIR\"):" >> launcher.py
        Write-Output "        return" >> launcher.py
        Write-Output "    " >> launcher.py
        Write-Output "    try:" >> launcher.py
        Write-Output "        os.makedirs(user_data_dir, exist_ok=True)" >> launcher.py
        Write-Output "        os.environ[\"ARGOS_PACKAGES_DIR\"] = user_data_dir" >> launcher.py
        Write-Output "    except Exception:" >> launcher.py
        Write-Output "        pass" >> launcher.py
        Write-Output "" >> launcher.py
        Write-Output "def main():" >> launcher.py
        Write-Output "    try:" >> launcher.py
        Write-Output "        setup_windows_environment()" >> launcher.py
        Write-Output "        configure_argos_packages()" >> launcher.py
        Write-Output "        " >> launcher.py
        Write-Output "        app_dir = os.path.dirname(os.path.abspath(__file__))" >> launcher.py
        Write-Output "        main_script = os.path.join(app_dir, \"main.py\")" >> launcher.py
        Write-Output "        " >> launcher.py
        Write-Output "        if not os.path.isfile(main_script):" >> launcher.py
        Write-Output "            print(f\"æ‰¾ä¸åˆ°ä¸»ç¨‹åº: {main_script}\")" >> launcher.py
        Write-Output "            sys.exit(1)" >> launcher.py
        Write-Output "        " >> launcher.py
        Write-Output "        # æ·»åŠ å½“å‰ç›®å½•åˆ°Pythonè·¯å¾„" >> launcher.py
        Write-Output "        sys.path.insert(0, app_dir)" >> launcher.py
        Write-Output "        " >> launcher.py
        Write-Output "        # å¯¼å…¥å¹¶è¿è¡Œä¸»ç¨‹åº" >> launcher.py
        Write-Output "        from main import main as app_main" >> launcher.py
        Write-Output "        app_main()" >> launcher.py
        Write-Output "            " >> launcher.py
        Write-Output "    except Exception as e:" >> launcher.py
        Write-Output "        traceback.print_exc()" >> launcher.py
        Write-Output "        input(\"ç¨‹åºå¼‚å¸¸ï¼ŒæŒ‰å›è½¦é”®é€€å‡º...\")" >> launcher.py
        Write-Output "        sys.exit(1)" >> launcher.py
        Write-Output "" >> launcher.py
        Write-Output "if __name__ == \"__main__\":" >> launcher.py
        Write-Output "    main()" >> launcher.py
      shell: powershell
      
    - name: Build with PyInstaller
      run: |
        Write-Host "å¼€å§‹æ„å»º Skylark Screen Translator..."
        
        # ä½¿ç”¨ç®€å•çš„PyInstallerå‘½ä»¤è€Œä¸æ˜¯specæ–‡ä»¶
        pyinstaller --name SkylarkTranslator `
          --onefile `
          --windowed `
          --icon icon.ico `
          --add-data "C:\Program Files\Tesseract-OCR\tesseract.exe;." `
          --add-data "C:\Program Files\Tesseract-OCR\tessdata;tessdata" `
          --hidden-import PyQt5.QtCore `
          --hidden-import PyQt5.QtGui `
          --hidden-import PyQt5.QtWidgets `
          --hidden-import pytesseract `
          --hidden-import PIL `
          --hidden-import mss `
          --hidden-import pynput `
          --hidden-import screeninfo `
          --hidden-import requests `
          --hidden-import argostranslate `
          --hidden-import stanza `
          --hidden-import ctranslate2 `
          --hidden-import sentencepiece `
          --hidden-import numpy `
          --hidden-import cv2 `
          --hidden-import ttkthemes `
          --hidden-import certifi `
          launcher.py
        
        # æ£€æŸ¥æ„å»ºæ˜¯å¦æˆåŠŸ
        if (!(Test-Path "dist\SkylarkTranslator.exe")) {
          throw "æ„å»ºå¤±è´¥ï¼šæ‰¾ä¸åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
        }
        
        Write-Host "æ„å»ºæˆåŠŸï¼"
      shell: powershell
      
    - name: Create distribution package
      run: |
        $releaseType = "${{ inputs.release_type }}"
        $version = Get-Date -Format "yyyy.MM.dd.HHmm"
        $packageName = "SkylarkTranslator_Windows_${releaseType}_v${version}"
        
        # åˆ›å»ºæ‰“åŒ…ç›®å½•
        New-Item -Path "dist\$packageName" -ItemType Directory -Force | Out-Null
        
        # å¤åˆ¶ç¨‹åºæ–‡ä»¶
        Copy-Item "dist\SkylarkTranslator.exe" "dist\$packageName\" -Force
        
        # å¤åˆ¶è¯­è¨€åŒ…
        $tessdataSrc = "C:\Program Files\Tesseract-OCR\tessdata"
        $tessdataDst = "dist\$packageName\tessdata"
        if (Test-Path $tessdataSrc) {
          New-Item -Path $tessdataDst -ItemType Directory -Force | Out-Null
          Copy-Item "$tessdataSrc\*.traineddata" $tessdataDst -Force
        }
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        Set-Content -Path "dist\$packageName\å¯åŠ¨ç¨‹åº.bat" -Value "@echo off
chcp 65001 > nul
echo å¯åŠ¨ Skylark Screen Translator...
cd /d %~dp0
start "" SkylarkTranslator.exe"
        
        # åˆ›å»ºè¯´æ˜æ–‡ä»¶
        Set-Content -Path "dist\$packageName\ä½¿ç”¨è¯´æ˜.txt" -Value "Skylark Screen Translator - Windows ç‰ˆæœ¬
ç‰ˆæœ¬: $version
ç±»å‹: $releaseType
æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

== å¿«é€Ÿå¼€å§‹ ==
1. åŒå‡» 'å¯åŠ¨ç¨‹åº.bat' æˆ–ç›´æ¥è¿è¡Œ SkylarkTranslator.exe
2. é¦–æ¬¡ä½¿ç”¨è¯·å…ˆè¿›å…¥'è¯­è¨€åŒ…ç®¡ç†'å®‰è£…ç¿»è¯‘åŒ…
3. å®‰è£…å®Œæˆåé‡å¯ç¨‹åºï¼Œåœ¨è®¾ç½®ä¸­é€‰æ‹©ç¿»è¯‘è¯­è¨€

== ä½¿ç”¨è¯´æ˜ ==
â€¢ å·¦é”®æ‹–æ‹½: é€‰æ‹©å±å¹•åŒºåŸŸ
â€¢ å³é”®åŒå‡»: æ‰§è¡ŒOCRå’Œç¿»è¯‘
â€¢ å·¦é”®å•å‡»: æ˜¾ç¤º/éšè—ç¿»è¯‘çª—å£
â€¢ é¼ æ ‡æ»šè½®: æ»šåŠ¨ç¿»è¯‘å†…å®¹

== æ³¨æ„äº‹é¡¹ ==
â€¢ è¿™æ˜¯æœªç­¾åçš„æµ‹è¯•ç‰ˆæœ¬
â€¢ Windows Defenderå¯èƒ½ä¼šæ˜¾ç¤ºå®‰å…¨è­¦å‘Šï¼ˆæ­£å¸¸ç°è±¡ï¼‰
â€¢ éœ€è¦CPUæ”¯æŒSSE4.1æŒ‡ä»¤é›†
â€¢ å»ºè®®è¿è¡Œå†…å­˜2GBä»¥ä¸Š

== é—®é¢˜åé¦ˆ ==
å¦‚é‡åˆ°é—®é¢˜è¯·åˆ°GitHubä»“åº“åé¦ˆ:
https://github.com/jtliaw/Skylark-Screen-Translator"
        
        # åˆ›å»ºZIPåŒ…
        Compress-Archive -Path "dist\$packageName" -DestinationPath "dist\$packageName.zip" -Force
        
        Write-Host "æ‰“åŒ…å®Œæˆ: $packageName.zip"
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "PACKAGE_NAME=$packageName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "PACKAGE_PATH=dist/$packageName.zip" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: powershell
      
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: SkylarkTranslator-Windows-${{ inputs.release_type }}
        path: ${{ env.PACKAGE_PATH }}
        retention-days: 7
        
    - name: Create release summary
      run: |
        $size = (Get-Item "${{ env.PACKAGE_PATH }}").Length
        $sizeMB = [math]::Round($size/1MB, 2)
        
        Write-Host "## æ„å»ºå®Œæˆ âœ…" 
        Write-Host "- å‘å¸ƒç±»å‹: ${{ inputs.release_type }}"
        Write-Host "- åŒ…å«è°ƒè¯•ä¿¡æ¯: ${{ inputs.include_debug }}"
        Write-Host "- æ–‡ä»¶å¤§å°: ${sizeMB} MB"
        Write-Host "- æ–‡ä»¶å: ${{ env.PACKAGE_NAME }}.zip"
        Write-Host ""
        Write-Host "ğŸ“¥ ä¸‹è½½æ„å»ºçš„æ–‡ä»¶:"
        Write-Host "1. ç‚¹å‡»ä¸Šæ–¹çš„ Actions æ ‡ç­¾"
        Write-Host "2. é€‰æ‹©è¿™æ¬¡è¿è¡Œ"
        Write-Host "3. åœ¨ Artifacts éƒ¨åˆ†ä¸‹è½½ ZIP æ–‡ä»¶"
        Write-Host ""
        Write-Host "ğŸ§ª æµ‹è¯•è¯´æ˜:"
        Write-Host "1. è§£å‹ZIPæ–‡ä»¶"
        Write-Host "2. è¿è¡Œ å¯åŠ¨ç¨‹åº.bat æˆ–ç›´æ¥è¿è¡Œ SkylarkTranslator.exe"
        Write-Host "3. é¦–æ¬¡è¿è¡Œéœ€è¦å®‰è£…è¯­è¨€åŒ…"
      shell: powershell
